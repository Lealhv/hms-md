<!DOCTYPE html>
<html lang="en" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="services/reshumot.server.js" defer></script>

    <title>מערכת ניהול מסמכים מאובטחת</title>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Add SweetAlert2 CSS and JS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.16.9/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script type="module" src="services/userLog.server.js"></script>
    <script src="services/mnilvim.server.js" defer></script>
    <script src="services/Suppliers.server.js" defer></script>


    <style>
        /* Modal Dialog Styling */
        /* Add these rules to the existing style section */
        html,
        body {
            height: auto;
            min-height: 100%;
            overflow-y: auto;
            margin: 0;
            padding: 0;
        }

        .container {
            max-height: none;
            overflow-y: visible;
        }

        /* Make sure modals don't affect main page scrolling */
        .modal-content {
            max-height: 85vh;
            overflow-y: auto;
        }

        /* Ensure the page content can grow beyond viewport */
        body>.container {
            padding-bottom: 50px;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.5);
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 0;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            width: 80%;
            max-width: 800px;
            animation: slideDown 0.4s;
            max-height: 85vh;
            overflow-y: auto;
        }

        @keyframes slideDown {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background-color: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            border-radius: 8px 8px 0 0;
        }

        .modal-title {
            margin: 0;
            color: #333;
            font-size: 1.5rem;
        }

        .close {
            background: none;
            border: none;
            font-size: 24px;
            font-weight: bold;
            color: #d50b0b;
            cursor: pointer;
            transition: color 0.2s;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            padding: 0;
            line-height: 1;
        }

        .close:hover {
            color: #000;
            background-color: rgba(0, 0, 0, 0.1);
        }

        #documentForm {
            padding: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
        }

        .form-group {
            margin-bottom: 15px;
            position: relative;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #555;
        }

        .form-group input[type="text"],
        .form-group input[type="number"],
        .form-group input[type="email"],
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            border-color: #4a90e2;
            outline: none;
            box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1);
        }

        .checkbox-container {
            display: flex;
            align-items: center;
        }

        .checkbox-container label {
            margin-left: 10px;
            margin-bottom: 0;
        }

        .checkbox-container input[type="checkbox"] {
            width: 18px;
            height: 18px;
        }

        .btn-container {
            grid-column: 1 / -1;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }

        .form-action-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .btn-primary {
            background-color: #4a90e2;
            color: white;
        }

        .btn-primary:hover {
            background-color: #3a7bc8;
        }

        .btn-secondary {
            background-color: #f1f1f1;
            color: #333;
        }

        .btn-secondary:hover {
            background-color: #e1e1e1;
        }

        .error-message {
            font-size: 12px;
            margin-top: 5px;
        }

        .action-buttons-overlay {
            display: flex;
            gap: 5px;
            margin-top: 5px;
            justify-content: flex-end;
        }

        .section {
            margin: 20px 0;
            padding: 10px;
            border: 1px solid #ccc;
        }

        .record-row {
            position: relative;
        }

        /* Remove the highlighting styles */
        .selected-row {
            background-color: transparent !important;
        }

        /* Make sure buttons are visible */
        .btn-sm {
            padding: 3px 8px;
            font-size: 0.8rem;
        }

        /* Header section styles */
        #header {
            background-color: #3498db;
            color: white;
            padding: 20px 0;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .header-container {
            width: 90%;
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-container h1 {
            margin: 0;
            font-size: 28px;
            font-weight: bold;
        }

        /* This would be for the commented-out admin button */
        .admin-btn {
            background-color: #13518f;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }

        .admin-btn:hover {
            background-color: #1a252f;
        }

        /* Header styling */
        #header {
            background: linear-gradient(135deg, #2c3e50, #3498db);
            color: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            margin-bottom: 25px;
            border: none;
            padding: 0;
            overflow: hidden;
            text-align: center;
        }

        .header-container {
            padding: 20px 30px;
            position: relative;
        }

        .title-area {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .title-area h1 {
            margin: 0;
            font-size: 2.2rem;
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .subtitle {
            margin: 5px 0 0;
            font-size: 1rem;
            opacity: 0.8;
            font-weight: 300;
        }

        /* Add a decorative element */
        .header-container:after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(to right, #3498db, #2ecc71, #f1c40f, #e74c3c);
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .header-container {
                padding: 15px;
            }

            .title-area h1 {
                font-size: 1.8rem;
            }
        }

        /* Upload Section Styling */
        .upload-section {
            background: linear-gradient(to left, #f8f9fa, #ffffff);
            border-radius: 10px;
            padding: 20px;
            margin: 25px 0;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
            border-right: 4px solid #3498db;
        }

        .upload-title {
            color: #2c3e50;
            font-size: 1.2rem;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .upload-buttons-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }

        .upload-button-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: transform 0.2s;
        }

        .upload-button-wrapper:hover {
            transform: translateY(-3px);
        }

        .upload-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: white;
            border: 2px solid #3498db;
            color: #3498db;
            border-radius: 8px;
            padding: 15px 25px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 150px;
            height: 100px;
        }

        .upload-btn:hover {
            background: #3498db;
            color: white;
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
        }

        .upload-btn i {
            font-size: 2rem;
            margin-bottom: 8px;
        }

        .upload-hint {
            margin-top: 8px;
            color: #7f8c8d;
            font-size: 0.8rem;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .upload-buttons-container {
                flex-direction: column;
                align-items: center;
            }

            .upload-btn {
                width: 130px;
                height: 90px;
            }
        }

        /* Header actions styling */
        .header-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            padding: 10px 20px;
            margin-bottom: 20px;
            background-color: #f8f9fa;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            position: relative;
            z-index: 1;
            clear: both;
        }

        .header-actions .btn {
            padding: 8px 15px;
            border-radius: 5px;
            font-weight: 500;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .header-actions .btn i {
            font-size: 0.9rem;
        }

        .header-actions .btn-danger {
            background-color: #e74c3c;
            color: white;
            border: none;
        }

        .header-actions .btn-danger:hover {
            background-color: #c0392b;
        }

        .header-actions .btn:not(.btn-danger) {
            background-color: #3498db;
            color: white;
            border: none;
        }

        .header-actions .btn:not(.btn-danger):hover {
            background-color: #2980b9;
        }
    </style>

    <link rel="stylesheet" href="admin.style.css">
</head>

<body>
    <div class="container">

        <div class="section" id="header">
            <div class="header-container">
                <div class="logo-area">
                </div>
                <div class="title-area">
                    <h1>מערכת ניהול מסמכים</h1>
                    <p class="subtitle">המערכת המתקדמת לניהול ומעקב אחר מסמכים</p>
                </div>
            </div>
        </div>

        <div class="header-actions">
            <button class="btn" onclick="goToEmployeePage(2)"><i class="fas fa-user"></i> לעמוד עובד</button>
            <button class="btn btn-danger" onclick="logout()"><i class="fas fa-sign-out-alt"></i> יציאה</button>
        </div>


        <div class="upload-section">
            <h2><i class="fas fa-filter"></i> סינון רשומות</h2>
            <div class="filter-area">
                <input type="text" id="supplierFilter" placeholder="שם ספק">
                <input type="text" id="agentFilter" placeholder="שם סוכן">
                <button class="btn btn-secondary" onclick="clearFilters()"><i class="fas fa-eraser"></i> נקה</button>
                <button class="btn" onclick="filterRecords()"><i class="fas fa-search"></i> סנן</button>
            </div>
        </div>
        <!-- <label for="fileInput" class="btn">טעינת רשימת ספקים</label>
        <input type="file" id="fileInput" accept=".csv, .xls, .xlsx" style="display: none;" /> -->
        <!-- <div class="btn-upload">
        <button type="button" class="btn-secondary form-action-btn"
            onclick="document.getElementById('recordsFile').click();">
            <i class="fas fa-file-upload"></i> טעינת רשומות
        </button>
        <input type="file" id="recordsFile" style="display: none;" accept=".csv, .xls, .xlsx"
            onchange="loadRecords(event)">
        <input type="file" id="recordsFile" style="display: none;" accept=".xls,.xlsx" onchange="loadRecords(event)">
        <button type="button" class="btn-secondary form-action-btn"
            onclick="document.getElementById('Suppliers').click();">
            <i class="fas fa-file-upload"></i> טעינת  ספקים
        </button>

        </div> -->

        <div class="upload-section">
            <div class="upload-buttons-container">
                <div class="upload-button-wrapper">
                    <button type="button" class="upload-btn" onclick="document.getElementById('recordsFile').click();">
                        <i class="fas fa-file-upload"></i>
                        <span>טעינת רשומות</span>
                    </button>
                    <input type="file" id="recordsFile" style="display: none;" accept=".csv, .xls, .xlsx"
                        onchange="loadRecords(event)">
                </div>

                <div class="upload-button-wrapper">
                    <button type="button" class="upload-btn" onclick="document.getElementById('Suppliers').click();">
                        <i class="fas fa-users"></i>
                        <span>טעינת ספקים</span>
                    </button>
                    <input type="file" id="Suppliers" style="display: none;" accept=".csv, .xls, .xlsx"
                        onchange="loadFile(event)">
                </div>
            </div>
        </div>


        <!-- <button onclick="loadFile()">טעון קובץ</button> -->
        <div id="supplierList"></div>

        <div class="card">
            <h2><i class="fas fa-file-alt"></i> רשומות</h2>
            <div id="listAllReshumot"></div>
        </div>
    </div>

    <div id="editDialog" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title"> עריכת רשומה </h2>
                <button type="button" class="close" onclick="closeEditDialog()" aria-label="סגור">&times;</button>
            </div>
            <form id="documentForm">
                <!-- Row 1 -->
                <div class="form-group">
                    <label for="editDepartment">מחלקה:</label>
                    <input type="text" id="editDepartment" name="department" placeholder="הזן שם מחלקה">
                    <div id="error-department" class="error-message" style="color: red;"></div>
                </div>


                <div id="supplierList"></div>

                <div class="form-group">
                    <label for="supplierName">שם הספק:</label>
                    <select id="supplierName" name="supplierName">
                        <option value="" disabled selected>בחר ספק</option>
                    </select>
                    <div id="error-supplierName" class="error-message" style="color: red;"></div>
                </div>
                <div class="form-group checkbox-container">
                    <label for="exempt">עוסק פטור:</label>
                    <input type="checkbox" id="exempt" name="exempt">
                    <div id="error-exempt" class="error-message" style="color: red;"></div>
                </div>

                <div class="form-group">
                    <label for="amount">סכום:</label>
                    <input type="number" id="amount" name="amount" onchange="calculateVAT()" placeholder="הזן סכום">
                    <div id="error-amount" class="error-message" style="color: red;"></div>
                </div>

                <div class="form-group">
                    <label for="maam_id">מע"מ:</label>
                    <input type="number" id="maam_id" name="vat" readonly>
                    <div id="error-maam_id" class="error-message" style="color: red;"></div>
                </div>

                <div class="form-group">
                    <label for="scmaan">סכום מע"מ:</label>
                    <input type="number" id="scmaan" name="scmaan" readonly>
                    <div id="error-scmaan" class="error-message" style="color: red;"></div>
                </div>

                <div class="form-group">
                    <label for="totalAmount">סכום כולל:</label>
                    <input type="number" id="totalAmount" name="totalAmount" readonly>
                    <div id="error-totalAmount" class="error-message" style="color: red;"></div>
                </div>

                <div class="form-group">
                    <label for="deliveryPlace">מקום אספקה:</label>
                    <input type="text" id="deliveryPlace" name="deliveryPlace" placeholder="הזן מקום אספקה">
                    <div id="error-deliveryPlace" class="error-message" style="color: red;"></div>
                </div>

                <div class="form-group">
                    <label for="agentNumber">מס סוכן:</label>
                    <input type="text" id="agentNumber" name="agentNumber" placeholder="הזן מספר סוכן">
                    <div id="error-agentNumber" class="error-message" style="color: red;"></div>
                </div>

                <div class="form-group">
                    <label for="contactName">שם סוכן:</label>
                    <input type="text" id="contactName" name="contactName" placeholder="הזן שם סוכן">
                    <div id="error-contactName" class="error-message" style="color: red;"></div>
                </div>

                <div class="form-group">
                    <label for="contactPhone">טלפון סוכן:</label>
                    <input type="text" id="contactPhone" name="contactPhone" placeholder="הזן טלפון סוכן">
                    <div id="error-contactPhone" class="error-message" style="color: red;"></div>
                </div>

                <div class="form-group">
                    <label for="contactEmail">מייל סוכן:</label>
                    <input type="email" id="contactEmail" name="contactEmail" placeholder="הזן מייל סוכן">
                    <div id="error-contactEmail" class="error-message" style="color: red;"></div>
                </div>

                <div class="form-group">
                    <label for="projectName">שם פרויקט:</label>
                    <input type="text" id="projectName" name="projectName" placeholder="הזן שם פרויקט">
                    <div id="error-projectName" class="error-message" style="color: red;"></div>
                </div>

                <div class="form-group">
                    <label for="budgetItem">תקציב:</label>
                    <input type="number" id="budgetItem" name="budgetItem" placeholder="הזן תקציב">
                    <div id="error-budgetItem" class="error-message" style="color: red;"></div>
                </div>

                <!-- Hidden fields -->
                <input type="hidden" id="autoNumber" name="autoNumber">
                <input type="hidden" id="timestamp" name="timestamp">

                <div id="error-message" class="error-message" style="color: red;"></div>

                <!-- Buttons -->
                <div class="btn-container">
                    <button type="button" class="btn-secondary form-action-btn" onclick="closeEditDialog()">
                        <i class="fas fa-times-circle"></i>
                        ביטול
                    </button>
                    <button type="button" class="btn-primary form-action-btn" onclick="saveData()">
                        <i class="fas fa-save"></i> שמירת נתונים
                    </button>
                </div>
            </form>
        </div>
        <input type="file" id="document" style="display: none;" onchange="MnilvimUpload(event)">
        <input type="file" id="Suppliers" style="display: none;" onchange="loadFile(event)">

    </div>

    <script>
        if (document.referrer.includes("login")) {
            document.addEventListener('DOMContentLoaded', function () {
                updateUser(localStorage.getItem('userId'),
                    {
                        Lg_timestmpin: new Date().toLocaleString('sv-SE'),
                        Lg_status: 1
                    });
            });
        }

        let inactivityTime = function () {
            let timer;
            window.onload = resetTimer;
            window.onmousemove = resetTimer;
            window.onkeypress = resetTimer;

            function resetTimer() {
                clearTimeout(timer);
                timer = setTimeout(logout, 600000); // 10 דקות
            }
        };

        inactivityTime();

        async function getReshumot() {
            try {
                const reshumotListDiv = document.getElementById('listAllReshumot');

                // Check if the div exists
                if (!reshumotListDiv) {
                    console.error('listAllReshumot div not found in the DOM');
                    return;
                }

                // Show loading indicator
                reshumotListDiv.innerHTML = '<p>Loading data...</p>';

                let reshumot;
                try {
                    reshumot = await listAllReshumot();
                    if (reshumot && Array.isArray(reshumot) && reshumot.length > 0) {
                        // Store the data in a global variable for filtering
                        window.allReshumotData = reshumot;

                        // Display all data initially
                        fillForm(reshumot);
                    } else {
                        console.warn('No records returned from API');
                        reshumotListDiv.innerHTML = '<p>אין נתונים להצגה</p>';
                    }
                } catch (e) {
                    console.error('Error calling listAllReshumot:', e);
                    reshumotListDiv.innerHTML = '<p>שגיאה בטעינת נתונים: ' + e.message + '</p>';
                }
            } catch (error) {
                console.error('Error in getReshumot function:', error);
                const reshumotListDiv = document.getElementById('listAllReshumot');
                if (reshumotListDiv) {
                    reshumotListDiv.innerHTML = '<p>שגיאה בטעינת נתונים: ' + error.message + '</p>';
                }
            }
        }

        async function loadSuppliers() {
            const suppliers = await getAllSuppliers(); // הנחה שהפונקציה מחזירה את הספקים
            console.log(suppliers); // הוסף לוג כאן כדי לבדוק מה מוחזר
            debugger
            const supplierSelect = document.getElementById('supplierName');
            supplierSelect.innerHTML = '<option value="" disabled selected>בחר ספק</option>'; // ניקוי אפשרויות קודמות

            suppliers.forEach(supplier => {
                const option = document.createElement('option');
                option.value = supplier.SP_name; // הנח כאן את השם של הספק
                option.textContent = supplier.SP_name; // הנח כאן את השם של הספק
                supplierSelect.appendChild(option);
            });
        }


        // קרא לפונקציה בעת טעינת הדף
        document.addEventListener('DOMContentLoaded', loadSuppliers);


        // Separate function for filtering data
        function filterRecords() {
            // Check if we have data to filter
            if (!window.allReshumotData || !Array.isArray(window.allReshumotData)) {
                console.error('No data available for filtering');
                return;
            }

            // Get filter values with null checks
            const supplierFilterEl = document.getElementById('supplierFilter');
            const agentFilterEl = document.getElementById('agentFilter');

            const supplierName = supplierFilterEl ? supplierFilterEl.value.trim() : '';
            const agentName = agentFilterEl ? agentFilterEl.value.trim() : '';

            // Check if any filter is applied
            const hasFilters = supplierName !== '' || agentName !== '';

            if (!hasFilters) {
                // If no filters, show all data
                fillForm(window.allReshumotData);
                return;
            }

            // Apply filters
            const filteredData = window.allReshumotData.filter(record => {
                // Check supplier filter
                if (supplierName && !(record.Rsh_sapak && record.Rsh_sapak.toLowerCase().includes(supplierName.toLowerCase()))) {
                    return false;
                }

                // Check agent name filter
                if (agentName && !(record.Rsh_cname && record.Rsh_cname.toLowerCase().includes(agentName.toLowerCase()))) {
                    return false;
                }

                // If we get here, the record passed all filters
                return true;
            });
            // Display filtered data
            fillForm(filteredData);

            // Show message if no results
            if (filteredData.length === 0) {
                const reshumotListDiv = document.getElementById('listAllReshumot');
                reshumotListDiv.innerHTML = '<p class="no-results">אין תוצאות מתאימות לחיפוש שלך</p>';
            }
        }

        function clearFilters() {
            // Reset filter input values
            const supplierFilterEl = document.getElementById('supplierFilter');
            const agentFilterEl = document.getElementById('agentFilter');

            if (supplierFilterEl) supplierFilterEl.value = '';
            if (agentFilterEl) agentFilterEl.value = '';

            // Check if we have data to display
            if (window.allReshumotData && Array.isArray(window.allReshumotData)) {
                // Display all records by calling fillForm with the complete dataset
                fillForm(window.allReshumotData);
            } else {
                // If no data is available, refresh from the server
                getReshumot();
            }

            // Provide user feedback
            showNotification('הסינון נוקה', 'info', 2000);
        }

        function calculateVAT() {
            const amount = document.getElementById('amount').value;
            let maam = document.getElementById('maam_id').value;
            maam = maam / 100;
            const vat = amount * maam; // לדוגמה, מע"מ 17%
            document.getElementById('scmaan').value = vat;
            document.getElementById('totalAmount').value = parseFloat(amount) + vat;
        }

        function goToEmployeePage(variable) {
            localStorage.setItem('PR', variable);
            window.location.href = "worker.html";
        }

        function logout() {
            updateUser(localStorage.getItem('userId'), {
                Lg_timestmpiout: new Date().toLocaleString('sv-SE'),
                Lg_status: 0
            });
            alert("מתנתק מהמערכת...");
            window.location.href = 'login.html'; // הפניה לדף התחברות
        }

        let selectedRow = null; // משתנה לשמור על השורה הנבחרת

        function handleRowClick(row) {
            const recordId = row.getAttribute('data-id');

            // If the same row is clicked again, just toggle the accordion
            if (selectedRow === row) {
                toggleAccordion(row);
                return;
            }

            // If there's a previously selected row, remove its action buttons and close its accordion
            if (selectedRow) {
                const previousButtons = selectedRow.querySelector('.action-buttons-overlay');
                if (previousButtons) previousButtons.remove();
                toggleAccordion(selectedRow, 'close'); // Force close the previous accordion
            }

            // Update the selected row reference
            selectedRow = row;

            // Add action buttons without highlighting the row
            addActionButtons(row, recordId);

            // Open the accordion for this row
            toggleAccordion(row, 'open');
        }

        function addActionButtons(row, recordId) {
            // Remove any existing action buttons
            const existingButtons = row.querySelector('.action-buttons-overlay');
            if (existingButtons) existingButtons.remove();

            // Create action buttons overlay
            const actionButtonsOverlay = document.createElement('div');
            actionButtonsOverlay.className = 'action-buttons-overlay';
            actionButtonsOverlay.innerHTML = `
                <button class="btn btn-primary btn-sm" onclick="editRecord('${recordId}'); event.stopPropagation();"><i class="fas fa-edit"></i> עריכה</button>
                <button class="btn btn-danger btn-sm" onclick="deleteRecord('${recordId}'); event.stopPropagation();"><i class="fas fa-trash-alt"></i> מחיקה</button>
                <button type="button" class="btn btn-secondary btn-sm" onclick="document.getElementById('document').click(); event.stopPropagation();">
                    <i class="fas fa-file-upload"></i> הוספת מסמכים נילווים
                </button>
            `;
            row.appendChild(actionButtonsOverlay);
        }

        function fillForm(reshumot) {
            const reshumotListDiv = document.getElementById('listAllReshumot');

            if (!reshumot || reshumot.length === 0) {
                console.warn('No records to display in fillForm');
                reshumotListDiv.innerHTML = '<p>אין נתונים להצגה</p>';
                return;
            }

            const titleMapping = {
                'Rsh_date': 'תאריך',
                'Rsh_mchlaka': 'מחלקה',
                'Rsh_sapak': 'ספק',
                'Rsh_patoor': 'פטור',
                'Rsh_schoom': 'סכום',
                'Rsh_maam': 'מע"מ',
                'Rsh_schmaam': 'סכום מע"מ',
                'Rsh_schtotal': 'סכום כולל',
                'Rsh_aspaka': 'מקום אספקה',
                'Rsh_proyktnam': 'שם פרויקט',
                'Rsh_sochen': 'סוכן',
                'Rsh_cname': 'שם סוכן',
                'Rsh_cnametl': 'טלפון סוכן',
                'Rsh_cemail': 'מייל סוכן',
                'Rsh_takziv': 'תקציב'
            };

            const hiddenColumns = ['Rsh_id', 'Rsh_status'];

            try {
                let tableHTML = '<div class="table-responsive"><table class="records-table">';
                tableHTML += '<thead><tr>';
                for (const key in titleMapping) {
                    if (!hiddenColumns.includes(key)) {
                        tableHTML += `<th>${titleMapping[key]}</th>`;
                    }
                }
                tableHTML += '</tr></thead>';

                tableHTML += '<tbody>';
                reshumot.forEach(record => {
                    const recordId = record.Rsh_id;

                    // עדכון לקריאה לפונקציה החדשה
                    tableHTML += `<tr class="record-row" data-id="${recordId}" onclick="handleRowClick(this)">`;
                    for (const key in titleMapping) {
                        if (!hiddenColumns.includes(key)) {
                            tableHTML += `<td class="data-cell"><span class="cell-content">${record[key] || ''}</span></td>`;
                        }
                    }
                    tableHTML += '</tr>';

                    // אקורדיון עבור תוכן של viewMnilvim
                    tableHTML += `<tr class="accordion-content" id="accordion-${recordId}" style="display:none;">
                        <td colspan="${Object.keys(titleMapping).length}">
                            <div id="details-${recordId}">Loading details...</div>
                        </td>
                    </tr>`;
                });

                tableHTML += '</tbody></table></div>';
                reshumotListDiv.innerHTML = tableHTML;

                // טען את הפרטים עבור כל רשומה
                reshumot.forEach(record => {
                    viewMnilvim(record.Rsh_id).then(details => {
                        document.getElementById(`details-${record.Rsh_id}`).innerHTML = details; // עדכן את תוכן האקורדיון
                    });
                });

            } catch (error) {
                console.error("Error in fillForm:", error);
                reshumotListDiv.innerHTML = '<p>שגיאה בעיבוד הנתונים: ' + error.message + '</p>';
            }
        }

        // Modified toggleAccordion function to support forced open/close
        function toggleAccordion(row, forceState) {

            const recordId = row.getAttribute('data-id');
            document.getElementById('autoNumber').value = recordId;

            const accordionRow = document.getElementById(`accordion-${recordId}`);

            if (!accordionRow) return;

            if (forceState === 'open') {
                accordionRow.style.display = "table-row";
            } else if (forceState === 'close') {
                accordionRow.style.display = "none";
            } else {
                // Toggle as before
                accordionRow.style.display = accordionRow.style.display === "none" ? "table-row" : "none";
            }
        }

        // Replace toggleActions with selectRow
        function selectRow(row) {
            debugger
            const recordId = row.getAttribute('data-id');
            // Update the ID of the selected record
            document.getElementById('autoNumber').value = recordId;

            // Add action buttons without highlighting
            addActionButtons(row, recordId);


        }

        // Add the editRecord function
        function editRecord(recordId) {
            // Retrieve the selected record data
            const selectedRow = document.querySelector(`tr[data-id="${recordId}"]`);
            const record = {
                Rsh_mchlaka: selectedRow.querySelector('td:nth-child(2)').innerText, // מחלקה
                Rsh_sapak: selectedRow.querySelector('td:nth-child(3)').innerText, // ספק
                Rsh_patoor: selectedRow.querySelector('td:nth-child(4)').innerText === 'עוסק פטור' ? '1' : '0', // פטור
                Rsh_schoom: selectedRow.querySelector('td:nth-child(5)').innerText, // סכום
                Rsh_maam: selectedRow.querySelector('td:nth-child(6)').innerText, // מע"מ
                Rsh_schmaam: selectedRow.querySelector('td:nth-child(7)').innerText, // סכום מע"מ
                Rsh_schtotal: selectedRow.querySelector('td:nth-child(8)').innerText, // סכום כולל
                Rsh_aspaka: selectedRow.querySelector('td:nth-child(9)').innerText, // מקום אספקה
                Rsh_proyktnam: selectedRow.querySelector('td:nth-child(10)').innerText, // שם פרויקט
                Rsh_sochen: selectedRow.querySelector('td:nth-child(11)').innerText, // מס סוכן
                Rsh_cname: selectedRow.querySelector('td:nth-child(12)').innerText, // שם סוכן
                Rsh_cnametl: selectedRow.querySelector('td:nth-child(13)').innerText, // טלפון סוכן
                Rsh_cemail: selectedRow.querySelector('td:nth-child(14)').innerText, // מייל סוכן
                Rsh_takziv: selectedRow.querySelector('td:nth-child(15)').innerText // תקציב
            };
            if (document.getElementById('editDepartment')) {
                document.getElementById('editDepartment').value = record.Rsh_mchlaka || '';
            }

            if (document.getElementById('supplierName')) document.getElementById('supplierName').value = record.Rsh_sapak || '';
            if (document.getElementById('exempt')) document.getElementById('exempt').checked = record.Rsh_patoor === '1';
            if (document.getElementById('amount')) document.getElementById('amount').value = record.Rsh_schoom || '';
            if (document.getElementById('maam_id')) document.getElementById('maam_id').value = record.Rsh_maam || '';
            if (document.getElementById('scmaan')) document.getElementById('scmaan').value = record.Rsh_schmaam || '';
            if (document.getElementById('totalAmount')) document.getElementById('totalAmount').value = record.Rsh_schtotal || '';
            if (document.getElementById('deliveryPlace')) document.getElementById('deliveryPlace').value = record.Rsh_aspaka || '';
            if (document.getElementById('projectName')) document.getElementById('projectName').value = record.Rsh_proyktnam || '';
            if (document.getElementById('agentNumber')) document.getElementById('agentNumber').value = record.Rsh_sochen || '';
            if (document.getElementById('contactEmail')) document.getElementById('contactEmail').value = record.Rsh_cemail || '';
            if (document.getElementById('contactName')) document.getElementById('contactName').value = record.Rsh_cname || '';
            if (document.getElementById('contactPhone')) document.getElementById('contactPhone').value = record.Rsh_cnametl || '';
            if (document.getElementById('budgetItem')) document.getElementById('budgetItem').value = record.Rsh_takziv || '';

            // Show the edit dialog
            const modal = document.getElementById("editDialog");
            modal.style.display = "block";
        }

        // Function to close the edit dialog
        function closeEditDialog() {
            document.getElementById("editDialog").style.display = "none";
        }

        async function deleteRecord(recordId) {
            const result = await Swal.fire({
                title: 'אישור מחיקה',
                text: 'האם אתה בטוח שברצונך למחוק רשומה זו?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'כן, מחק את זה!',
                cancelButtonText: 'לא, ביטול'
            });

            if (result.isConfirmed) {
                const res = await deleteReshumot(recordId);
                if (res.message === "Reshumot deleted successfully") {
                    showNotification('הרשומה נמחקה בהצלחה');
                    getReshumot()
                } else {
                    showNotification('שגיאה במחיקת הרשומה');
                }
            }
        }
        async function saveData() {
            debugger

            const recordId = document.getElementById('autoNumber').value;

            if (!recordId) {
                console.error("recordId is not found or is empty");
                return; // טיפול בשגיאה אם ה-ID לא נמצא
            }
            debugger
            console.log("recordId =")
            console.log(recordId);
            // Fetch all records to check if the record already exists
            const records = await listAllReshumot();
            console.log("records =")
            console.log(records);
            const existingRecord = records.find(record => record.Rsh_id === recordId);

            const data = {
                Rsh_id: recordId,
                Rsh_date: document.getElementById('timestamp').value,
                Rsh_mchlaka: document.getElementById('editDepartment').value,
                Rsh_sapak: document.getElementById('supplierName').value,
                Rsh_patoor: document.getElementById('exempt').checked ? '1' : '0', // Use the checkbox value
                Rsh_schoom: document.getElementById('amount').value,
                Rsh_maam: document.getElementById('maam_id').value, // Changed from 'vat' to 'maam_id'
                Rsh_schmaam: document.getElementById('scmaan').value, // Changed from 'totalAmount' to 'scmaan'
                Rsh_schtotal: document.getElementById('totalAmount').value,
                Rsh_aspaka: document.getElementById('deliveryPlace').value, // Changed from 'contactName' to 'deliveryPlace'
                Rsh_proyktnam: document.getElementById('projectName').value,
                Rsh_email: document.getElementById('contactEmail').value,
                Rsh_sochen: document.getElementById('agentNumber').value, // Changed from 'contactPhone' to 'contactName'
                Rsh_takziv: document.getElementById('budgetItem').value, // Changed from 'agentNumber' to 'budgetItem'
                Rsh_cname: document.getElementById('contactName').value, // Changed from 'budgetItem' to 'contactName'
                // Rsh_cnametl: document.getElementById('contactPhone').value, // Added this field

                // שדות אחרים
                Rsh_cnametl: document.getElementById('contactPhone').value ? '0' + document.getElementById('contactPhone').value : '', // הוספת 0 בהתחלה
                // שדות אחרים
                Rsh_cemail: document.getElementById('contactEmail').value
            };
            console.log("data:")
            console.log(data)
            debugger
            try {
                data.Rsh_date = new Date().toLocaleString('sv-SE')
                // Lg_timestmpiout: new Date().toLocaleString('sv-SE'),
                // If record exists, update it
                const response = await updateReshumot(data);
                if (response.message === "Reshumot updated successfully") {
                    showNotification('רשומה עודכנה בהצלחה!', 'success');
                    getReshumot()
                    // location.reload();
                }
                else {
                    showNotification('שגיאה בעדכון הרשומה', 'error');

                }
                // If record does not exist, create it
                closeEditDialog();

                // showNotification('רשומה נשמרה בהצלחה!');
            }
            // clearFields(); // Clear fields after saving
            catch (error) {
                console.error('Error updating record:', error);
                showNotification('שגיאה בעדכון הרשומה: ' + error.message, 'error');
            }
        }



        function showNotification(message, type = 'success', duration = 3000) {
            // Remove any existing notifications
            const existingNotifications = document.querySelectorAll('.notification');
            existingNotifications.forEach(notification => {
                notification.remove();
            });

            // Create notification element
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;

            // Set icon based on notification type
            let icon = '';
            switch (type) {
                case 'success':
                    icon = 'fa-check-circle';
                    break;
                case 'error':
                    icon = 'fa-exclamation-circle';
                    break;
                case 'info':
                    icon = 'fa-info-circle';
                    break;
                case 'warning':
                    icon = 'fa-exclamation-triangle';
                    break;
            }

            // Create notification content
            notification.innerHTML = `
                <i class="fas ${icon}"></i>
                <span class="message">${message}</span>
                <button class="close-notification" onclick="this.parentElement.remove()">
                    <i class="fas fa-times"></i>
                </button>
            `;

            // Add to DOM
            document.body.appendChild(notification);

            // Auto-remove after duration
            if (duration > 0) {
                setTimeout(() => {
                    if (notification.parentElement) {
                        notification.classList.add('fade-out');
                        setTimeout(() => notification.remove(), 500);
                    }
                }, duration);
            }
        }

        async function viewMnilvim(id) {
            try {
                const data = await listMnilvim(id); // קבל את המידע

                // אם יש מינלווים, הצג את המידע
                if (Array.isArray(data) && data.length > 0) {
                    return data.map(mnilvim => `
                        <div>
                            <h4>פרטי מסמך ${mnilvim.MN_id}</h4>
                            <p>תאריך הוספה: ${mnilvim.MN_dateAdd}</p>
                            <p>מיקום: ${mnilvim.MN_location}</p>
                            <p>פרטים: ${mnilvim.MN_pratim}</p>
                            <p>שימוש: ${mnilvim.MN_shyooch}</p>
                            <p>סטטוס: ${mnilvim.MN_status}</p>
                            <p>סוג: ${mnilvim.MN_type}</p>
                        </div>
                    `).join(''); // חבר את כל המידע למחרוזת אחת
                } else {
                    // במידה ואין מינלווים, הצג הודעת שגיאה באקורדיון
                    return `
                        <div class="accordion">
                            <h4>אין מסמכים נילווים</h4>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error fetching mnilvim details:', error);
                // במידה ויש שגיאה, הצג הודעה באקורדיון
                return `
                    <div class="accordion">
                        <h4>אין מסמכים נילווים</h4>
                    </div>
                `;
            }
        }

        function MnilvimUpload(event) {

            event.preventDefault(); // למנוע את שליחת הטופס הרגילה

            const fileInput = document.getElementById('document');
            const data = {};

            // Get the selected record ID from the hidden input field
            const recordId = document.getElementById('autoNumber').value;

            if (!recordId) {
                showNotification("אנא בחר רשומה לפני הוספת מסמך", "error");
                return;
            }

            // הוסף את המידע הנוסף
            if (fileInput.files.length > 0) {
                const file = fileInput.files[0];
                const lastDotIndex = file.name.lastIndexOf('.');
                const fileNameWithoutExtension = lastDotIndex !== -1 ? file.name.substring(0, lastDotIndex) : file.name;
                data.MN_pratim = fileNameWithoutExtension;
                data.MN_location = fileInput.value; // מיקום הקובץ במחשב
                data.MN_shyooch = recordId; // Use the selected record ID instead of undefined RSH_ID
                data.MN_status = 1; // סטטוס
                data.MN_dateAdd = new Date().toISOString().split('T')[0]; // תאריך של היום
                data.MN_type = file.type; // סוג הקובץ
            }

            addMnilvim(data)
                .then(response => {
                    debugger
                    if (response.message === "Mnilvim created successfully") {
                        // הנח את ההודעה כאן אם ההוספה הצליחה
                        showNotification("הקובץ נוסף בהצלחה!");

                        // עדכון מיידי של רשימת המסמכים הנלווים לרשומה הספציפית
                        viewMnilvim(recordId).then(details => {
                            debugger
                            const detailsElement = document.getElementById(`details-${recordId}`);
                            if (detailsElement) {
                                detailsElement.innerHTML = details;

                                // פתח את האקורדיון אם הוא סגור
                                const accordionRow = document.getElementById(`accordion-${recordId}`);
                                if (accordionRow && accordionRow.style.display === "none") {
                                    accordionRow.style.display = "table-row";
                                }
                            }
                        });

                        // נקה את שדה הקובץ
                        fileInput.value = '';
                    }
                })
                .catch(error => {
                    // הנח את ההודעה כאן אם הייתה שגיאה
                    showNotification("אירעה שגיאה בהוספת הקובץ: " + error.message, "error");
                });
        }


        function loadFile(event) {
            const fileInput = event.target; // קבלת שדה הקלט מתוך האירוע
            const file = fileInput.files[0];

            if (!file) {
                showNotification('אנא בחר קובץ.');
                return;
            }

            const fileExtension = file.name.split('.').pop().toLowerCase();

            if (fileExtension === 'csv') {
                loadCSV(file);
            } else if (fileExtension === 'xls' || fileExtension === 'xlsx') {
                loadExcel(file);
            } else {
                showNotification('פורמט קובץ לא נתמך. אנא בחר קובץ CSV או Excel.');
            }
        }

        function loadCSV(file) {
            Papa.parse(file, {
                header: true,
                complete: async function (results) {
                    const suppliers = results.data.map(supplier => ({ SP_name: supplier.SP_name }));

                    try {
                        const response = await createSupplier(suppliers); // שלח את כל הספקים ל-createSuppliers
                        if (response.status === 200) {
                            loadSuppliers(); // עדכן את רשימת הספקים כאן
                        } else {
                            showNotification('נכשלה יצירת הספקים: ' + response.statusText);
                        }
                    } catch (error) {
                        showNotification('שגיאה ביצירת ספקים: ' + error.message);
                    }
                },
                error: function (error) {
                    showNotification('שגיאה בטעינת CSV: ' + error.message);
                }
            });
        }

        function loadExcel(file) {
            const reader = new FileReader();
            reader.onload = async function (e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });

                // הנחה שהשמות נמצאים בעמודה הראשונה
                const suppliers = jsonData.map(row => ({ SP_name: row[0] }));

                try {
                    const response = await createSupplier(suppliers); // שלח את כל הספקים ל-createSuppliers
                    if (response.status === 200) {
                        loadSuppliers(); // עדכן את רשימת הספקים כאן
                        showNotification('הספקים נוספו בהצלחה!');
                    } else {
                        showNotification('נכשלה יצירת הספקים: ' + response.statusText);
                    }
                } catch (error) {
                    showNotification('שגיאה ביצירת ספקים: ' + error.message);
                }
            };
            reader.readAsArrayBuffer(file);
        }


        function displaySuppliers(suppliers) {
            const supplierListDiv = document.getElementById('supplierList');
            const supplierSelect = document.getElementById('supplierName');

            suppliers.forEach(supplier => {
                const supplierElement = document.createElement('div');
                supplierElement.textContent = supplier;
                supplierListDiv.appendChild(supplierElement);

                const option = document.createElement('option');
                option.value = supplier;
                option.textContent = supplier;
                supplierSelect.appendChild(option);
            });
        }

        function loadRecords(event) {
            const fileInput = event.target;
            const file = fileInput.files[0];

            if (!file) {
                showNotification('אנא בחר קובץ.');
                return;
            }

            const fileExtension = file.name.split('.').pop().toLowerCase();

            if (fileExtension === 'csv') {
                loadCSVRecords(file);
            } else if (fileExtension === 'xls' || fileExtension === 'xlsx') {
                loadExcelRecords(file);
            } else {
                showNotification('פורמט קובץ לא נתמך. אנא בחר קובץ CSV או Excel.');
            }
        }

        function loadCSVRecords(file) {
            Papa.parse(file, {
                header: true,
                complete: async function (results) {
                    const records = results.data.map(row => {
                        console.log(row);
                        debugger; // עצור כאן כדי לבדוק את הערכים של row
                        return {
                            Rsh_id: row["Record Number"], // מיפוי ל-Rsh_id
                            Rsh_date: row["Timestamp"], // מיפוי ל-Rsh_date
                            Rsh_mchlaka: row["Department"], // מיפוי ל-Rsh_mchlaka
                            Rsh_sapak: row["Supplier Name"], // מיפוי ל-Rsh_sapak
                            Rsh_patoor: row["Contact Phone"], // מיפוי ל-Rsh_patoor
                            Rsh_schoom: row["Amount"], // מיפוי ל-Rsh_schoom
                            Rsh_maam: row["VAT"], // מיפוי ל-Rsh_maam
                            Rsh_schmaam: row["Total Amount"], // מיפוי ל-Rsh_schmaam
                            Rsh_aspaka: row["Delivery Location"], // מיפוי ל-Rsh_aspaka
                            Rsh_proyktnam: row["Project Name"], // מיפוי ל-Rsh_proyktnam
                            Rsh_sochen: row["Contact Name"], // מיפוי ל-Rsh_sochen
                            Rsh_takziv: row["Contact Email"], // מיפוי ל-Rsh_takziv
                            Rsh_cname: row["Delivery Location"], // מיפוי ל-Rsh_cname
                            Rsh_cnametl: row["Delivery Location"], // אם יש צורך בשדה נוסף
                        };
                    });


                    console.log(records);
                    debugger
                    try {
                        const response = await createReshumot(records); // שלח את כל הרשומות ל-createRecords
                        if (response.status === 200) {
                            showNotification('הרשומות נוספו בהצלחה!');
                        } else {
                            console.error('Failed to create records:', response);
                            showNotification('שגיאה בהוספת הרשומות');
                        }
                    } catch (error) {
                        console.error('Error creating records:', error);
                        showNotification('שגיאה בהוספת הרשומות: ' + error.message);
                    }
                },
                error: function (error) {
                    console.error('Error loading CSV:', error);
                    showNotification('שגיאה בטעינת קובץ CSV: ' + error.message);
                }
            });
        }

        function loadExcelRecords(file) {
            const reader = new FileReader();
            reader.onload = async function (e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });

                // הנחה שהשמות נמצאים בעמודות
                const records = jsonData.map(row => ({
                    // הנח כאן את מיפוי השדות שלך
                    field1: row[0], // לדוגמה
                    field2: row[1], // לדוגמה
                    // הוסף שדות נוספים לפי הצורך
                }));

                try {
                    const response = await createReshumot(records); // שלח את כל הרשומות ל-createRecords
                    if (response.status === 200) {
                        showNotification('הרשומות נוספו בהצלחה!');
                    } else {
                        console.error('Failed to create records:', response);
                        showNotification('שגיאה בהוספת הרשומות');
                    }
                } catch (error) {
                    console.error('Error creating records:', error);
                    showNotification('שגיאה בהוספת הרשומות: ' + error.message);
                }
            };
            reader.readAsArrayBuffer(file);
        }


        // Make sure the document is ready before calling getReshumot
        document.addEventListener('DOMContentLoaded', function () {
            getReshumot();
            loadSuppliers();
        });
    </script>
</body>

</html>