<!DOCTYPE html>
<html lang="en" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="services/reshumot.server.js" defer></script>

    <title>מערכת ניהול מסמכים מאובטחת</title>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script type="module" src="services/userLog.server.js"></script>
        <script src="services/reshumot.server.js" defer></script>

    <link rel="stylesheet" href="admin.style.css">

</head>

<body>
    <header>
        <div class="container">
            <h1>מערכת ניהול מסמכים מאובטחת</h1>
        </div>


    </header>

    <div class="container">
        <button class="btn" onclick="goToEmployeePage(2)">לעמוד עובד</button>

        <div class="footer-actions">
            <button class="btn btn-danger" onclick="logout()"><i class="fas fa-sign-out-alt"></i> התנתק</button>
        </div>

        <div class="card">
            <h2><i class="fas fa-filter"></i> סינון מסמכים</h2>
            <div class="filter-area">
                <input type="text" id="orderNumber" placeholder="מספר הזמנה">
                <input type="text" id="department" placeholder="מחלקה">
                <input type="date" id="date">
                <button class="btn btn-secondary" onclick="clearFilters()"><i class="fas fa-eraser"></i> נקה</button>
                <button class="btn" onclick="filterRecords()"><i class="fas fa-search"></i> סנן</button>
            </div>
        </div>

        <div class="card">
            <h2><i class="fas fa-file-alt"></i> רשימת רשומות</h2>
            <div id="listAllReshumot"></div>
        </div>

        <div class="status" id="statusMessage">
            <i class="fas fa-info-circle"></i> סטטוס: לא נבחר מסמך
        </div>

        <div class="card">
            <h2><i class="fas fa-file-pdf"></i> תצוגה מקדימה של המסמך</h2>
            <div id="documentPreview">
                <!-- תצוגה מקדימה של המסמך תוצג כאן -->
                <div style="text-align: center; padding: 100px 0; color: #aaa;">
                    <i class="fas fa-file-pdf" style="font-size: 48px;"></i>
                    <p>בחר מסמך מהרשימה לצפייה</p>
                </div>
            </div>
        </div>

    </div>

    <script>
        if (document.referrer.includes("login")) {
            document.addEventListener('DOMContentLoaded', function () {
                updateUser(localStorage.getItem('userId'),
                    {
                        Lg_timestmpin: new Date().toLocaleString('sv-SE'),
                        Lg_status: 1
                    });
            });
        }

        let inactivityTime = function () {
            let timer;
            window.onload = resetTimer;
            window.onmousemove = resetTimer;
            window.onkeypress = resetTimer;

            function resetTimer() {
                clearTimeout(timer);
                timer = setTimeout(logout, 600000); // 10 דקות
            }
        };

        inactivityTime();

        function clearFilters() {
            document.getElementById('orderNumber').value = '';
            document.getElementById('department').value = '';
            document.getElementById('date').value = '';
        }

        function filterRecords() {
            // לוגיקה לסינון רשומות על בסיס שדות הקלט
            alert("מסנן רשומות...");
        }

        function loadDocument(documentId) {
            // לוגיקה לטעינה והצגת המסמך
            document.getElementById('statusMessage').innerHTML = '<i class="fas fa-check-circle" style="color: #2ecc71;"></i> סטטוס: מסמך ' + documentId + ' נטען בהצלחה.';

            // דוגמה להצגת תוכן מסמך
            document.getElementById('documentPreview').innerHTML = `
                <div style="text-align: center; padding: 20px;">
                    <h3>מסמך ${documentId}</h3>
                    <div style="border: 1px solid #ddd; padding: 20px; margin-top: 20px;">
                        <p>זוהי תצוגה מקדימה של מסמך ${documentId}.</p>
                        <p>כאן יוצג תוכן המסמך האמיתי.</p>
                    </div>
                </div>
            `;
        }

        function goToEmployeePage(variable) {
            localStorage.setItem('PR', variable);
            window.location.href = "worker.html";
        }


        function logout() {
            updateUser(localStorage.getItem('userId'), {
                Lg_timestmpiout: new Date().toLocaleString('sv-SE'),
                Lg_status: 0
            });
            alert("מתנתק מהמערכת...");
            window.location.href = 'login.html'; // הפניה לדף התחברות
        }

        async function getReshumot() {
            try {
                let reshumot;
                try {
                    reshumot = await listAllReshumot();
                    fillForm(reshumot);
                } catch (e) {
                    console.error('Error calling listAllReshumot:', e);
                    reshumotListDiv.innerHTML = '<p>Error fetching data: ' + e.message + '</p>';
                    return;
                }

                if (!reshumot) {
                    console.warn('Reshumot data is null or undefined');
                    reshumotListDiv.innerHTML = '<p>No data available</p>';
                    return;
                }

            } catch (error) {
                console.error('Error in getReshumot function:', error);
                const reshumotListDiv = document.getElementById('reshumotList');
                if (reshumotListDiv) {
                    reshumotListDiv.innerHTML = '<p>Error loading data: ' + error.message + '</p>';
                }
            }
        }

        function fillForm(reshumot) {
            const reshumotListDiv = document.getElementById('listAllReshumot');

            if (!reshumot || reshumot.length === 0) {
                reshumotListDiv.innerHTML = '<p>אין נתונים להצגה</p>';
                return;
            }

            const titleMapping = {
                'Rsh_id': 'מספר רשומה',
                'Rsh_date': 'תאריך',
                'Rsh_mchlaka': 'מחלקה',
                'Rsh_sapak': 'ספק',
                'Rsh_patoor': 'פטור',
                'Rsh_schoom': 'סכום',
                'Rsh_maam': 'מע"מ',
                'Rsh_schmaam': 'סכום מע"מ',
                'Rsh_schtotal': 'סכום כולל',
                'Rsh_aspaka': 'מקום אספקה',
                'Rsh_proyktnam': 'שם פרויקט',
                'Rsh_status': 'סטטוס',
                'Rsh_sochen': 'סוכן',
                'Rsh_takziv': 'תזכיר',
                'Rsh_cname': 'שם לקוח',
                'Rsh_cnametl': 'טלפון לקוח',
                'Rsh_cemail': 'מייל לקוח'
            };

            // Create table
            let tableHTML = '<div class="table-responsive"><table class="records-table">';

            // Create header row
            tableHTML += '<thead><tr>';
            tableHTML += `<th>פעולות</th>`; // Add Actions column header
            for (const key in titleMapping) {
                if (key !== 'Rsh_id') { // Skip ID as it's not needed in the header
                    tableHTML += `<th>${titleMapping[key]}</th>`;
                }
            }
            tableHTML += '</tr></thead>';

            // Create table body
            tableHTML += '<tbody>';
            reshumot.forEach(record => {
                tableHTML += `<tr data-id="${record.Rsh_id}">`;

                // First cell with action buttons
                tableHTML += `<td>
            <div class="action-buttons">
                <button class="btn-action btn-edit" onclick="editRecord('${record.Rsh_id}')">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="btn-action btn-delete" onclick="deleteRecord('${record.Rsh_id}')">
                    <i class="fas fa-trash-alt"></i>
                </button>
                <button class="btn-action btn-view" onclick="loadDocument('${record.Rsh_id}')">
                    <i class="fas fa-eye"></i>
                </button>
            </div>
        </td>`;

                // Rest of the cells
                for (const key in titleMapping) {
                    if (key === 'Rsh_id') continue; // Skip ID as it's already in the first cell

                    // Format date if the field is a date
                    if (key === 'Rsh_date' && record[key]) {
                        const date = new Date(record[key]);
                        if (!isNaN(date)) {
                            tableHTML += `<td>${date.toLocaleDateString('he-IL')}</td>`;
                        } else {
                            tableHTML += `<td>${record[key] || ''}</td>`;
                        }
                    } else {
                        tableHTML += `<td>${record[key] || ''}</td>`;
                    }
                }

                tableHTML += '</tr>';
            });

            tableHTML += '</tbody></table></div>';

            // Add table to the DOM
            reshumotListDiv.innerHTML = tableHTML;

            // Add some styling for better table appearance
            const style = document.createElement('style');
            style.textContent = `
        .table-responsive {
            overflow-x: auto;
            margin-bottom: 20px;
        }
        .records-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        .records-table th, .records-table td {
            padding: 8px;
            border: 1px solid #ddd;
            text-align: right;
            position: relative;
        }
        .records-table th {
            background-color: #3498db;
            color: white;
            font-weight: bold;
            position: sticky;
            top: 0;
            box-shadow: 0 2px 2px -1px rgba(0, 0, 0, 0.1);
        }
        .records-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        .records-table tr:hover {
            background-color: #e9e9e9;
        }
        .action-buttons {
            display: flex;
            gap: 5px;
        }
        .btn-action {
            border: none;
            border-radius: 4px;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-edit {
            background-color: #3498db;
            color: white;
        }
        .btn-delete {
            background-color: #e74c3c;
            color: white;
        }
        .btn-view {
            background-color: #2ecc71;
            color: white;
        }
        .btn-action:hover {
            transform: scale(1.1);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
    `;
            document.head.appendChild(style);

            // Add placeholder functions for edit and delete if they don't exist
            if (typeof window.editRecord !== 'function') {
                window.editRecord = function (id) {
                    alert('עריכת רשומה: ' + id);
                };
            }

            // if (typeof window.deleteRecord !== 'function') {
            //     window.deleteRecord = function (id) {
            //         console.log('Delete record:', id);
            //         if (confirm('האם אתה בטוח שברצונך למחוק את רשומה ' + id + '?')) {
            //             alert('רשומה ' + id + ' נמחקה בהצלחה');
            //         }
            //     };
            // }
            const deleteButton = document.createElement('button');
            deleteButton.textContent = 'מחיקה';
            deleteButton.className = 'btn-danger';
            deleteButton.style.padding = '5px 10px';
            deleteButton.style.borderRadius = '4px';
            deleteButton.style.cursor = 'pointer';
            deleteButton.onclick = function () {
                Swal.fire({
                    title: 'אישור מחיקה',
                    text: 'האם אתה בטוח שברצונך למחוק רשומה זו?',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    cancelButtonColor: '#3085d6',
                    confirmButtonText: 'כן, מחק את זה!',
                    cancelButtonText: 'לא, ביטול'
                }).then((result) => {
                    if (result.isConfirmed) {
                        // Delete record functionality would go here
                        showNotification('הרשומה נמחקה בהצלחה');
                        recordCard.remove();
                    }
                });
            };

        }


        document.addEventListener('DOMContentLoaded', function () {
            getReshumot();
        });

        async function deleteRecord(recordId) {
            const result = await Swal.fire({
                title: 'אישור מחיקה',
                text: 'האם אתה בטוח שברצונך למחוק רשומה זו?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'כן, מחק את זה!',
                cancelButtonText: 'לא, ביטול'
            });

            if (result.isConfirmed) {
                const res = await deleteReshumot(recordId);
                if (res.message === "Reshumot deleted successfully") {
                    showNotification('הרשומה נמחקה בהצלחה');
                } else {
                    showNotification('שגיאה במחיקת הרשומה');
                }
            }
        }


    </script>
</body>

</html>