<!DOCTYPE html>
<html lang="he">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>מערכת ניהול מסמכים</title>
    <link rel="stylesheet" href="worker.style.css">

    <style>
        body {
            font-family: Arial, sans-serif;
        }

        .container {
            width: 80%;
            margin: auto;
        }

        .section {
            margin: 20px 0;
            padding: 10px;
            border: 1px solid #ccc;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-left: 4px solid #007bff;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            max-width: 300px;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            z-index: 1000;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            border-left-color: #28a745;
        }

        .notification.error {
            border-left-color: #dc3545;
        }

        .notification-icon {
            margin-right: 10px;
            font-size: 1.2em;
        }

        .notification-message {
            flex-grow: 1;
        }

        .notification-close {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1em;
        }
    </style>
    <script src="services/reshumot.server.js" defer></script>
    <script src="services/maam.server.js" defer></script>
    <script src="services/mnilvim.server.js" defer></script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <!-- הוספת קישור לספריית html2pdf -->
</head>

<body onload="getData()">
    <div class="container">
        <div class="section" id="header">
            <h1>מערכת ניהול מסמכים</h1>
            <button id="conditionalButton" class="btn" onclick="goToAdmin()">לעמוד מנהל</button>
        </div>

        <div class="section" id="input-form">

            <h2>טופס קלט</h2>
            <form id="documentForm">
                <!-- Row 1 -->
                <div class="form-group">
                    <label for="department">מחלקה:</label>
                    <input type="text" id="department" name="department" placeholder="הזן שם מחלקה">
                    <div id="error-department" class="error-message" style="color: red;"></div>
                </div>

                <div class="form-group">
                    <label for="supplierName">שם הספק:</label>
                    <select id="supplierName" name="supplierName">
                        <option value="" disabled selected>בחר ספק</option>
                        <option value="ספק 1">ספק 1</option>
                        <option value="ספק 2">ספק 2</option>
                    </select>
                    <div id="error-supplierName" class="error-message" style="color: red;"></div>
                </div>

                <div class="form-group checkbox-container">
                    <label for="exempt">עוסק פטור:</label>
                    <input type="checkbox" id="exempt" name="exempt">
                    <div id="error-exempt" class="error-message" style="color: red;"></div>
                </div>

                <div class="form-group">
                    <label for="amount">סכום:</label>
                    <input type="number" id="amount" name="amount" onchange="calculateVAT()" placeholder="הזן סכום">
                    <div id="error-amount" class="error-message" style="color: red;"></div>
                </div>

                <div class="form-group">
                    <label for="maam_id">מע"מ:</label>
                    <input type="number" id="maam_id" name="vat" readonly>
                    <div id="error-maam_id" class="error-message" style="color: red;"></div>
                </div>

                <div class="form-group">
                    <label for="scmaan">סכום מע"מ:</label>
                    <input type="number" id="scmaan" name="scmaan" readonly>
                    <div id="error-scmaan" class="error-message" style="color: red;"></div>
                </div>

                <div class="form-group">
                    <label for="totalAmount">סכום כולל:</label>
                    <input type="number" id="totalAmount" name="totalAmount" readonly>
                    <div id="error-totalAmount" class="error-message" style="color: red;"></div>
                </div>

                <div class="form-group">
                    <label for="deliveryPlace">מקום אספקה:</label>
                    <input type="text" id="deliveryPlace" name="deliveryPlace" placeholder="הזן מקום אספקה">
                    <div id="error-deliveryPlace" class="error-message" style="color: red;"></div>
                </div>

                <div class="form-group">
                    <label for="agentNumber">מס סוכן:</label>
                    <input type="text" id="agentNumber" name="agentNumber" placeholder="הזן מספר סוכן">
                    <div id="error-agentNumber" class="error-message" style="color: red;"></div>
                </div>

                <div class="form-group">
                    <label for="contactName">שם סוכן:</label>
                    <input type="text" id="contactName" name="contactName" placeholder="הזן שם סוכן">
                    <div id="error-contactName" class="error-message" style="color: red;"></div>
                </div>

                <div class="form-group">
                    <label for="contactPhone">טלפון סוכן:</label>
                    <input type="text" id="contactPhone" name="contactPhone" placeholder="הזן טלפון סוכן">
                    <div id="error-contactPhone" class="error-message" style="color: red;"></div>
                </div>

                <div class="form-group">
                    <label for="contactEmail">מייל סוכן:</label>
                    <input type="email" id="contactEmail" name="contactEmail" placeholder="הזן מייל סוכן">
                    <div id="error-contactEmail" class="error-message" style="color: red;"></div>
                </div>

                <div class="form-group">
                    <label for="projectName">שם פרויקט:</label>
                    <input type="text" id="projectName" name="projectName" placeholder="הזן שם פרויקט">
                    <div id="error-projectName" class="error-message" style="color: red;"></div>
                </div>

                <div class="form-group">
                    <label for="budgetItem">תקציב:</label>
                    <input type="number" id="budgetItem" name="budgetItem" placeholder="הזן תקציב">
                    <div id="error-budgetItem" class="error-message" style="color: red;"></div>
                </div>

                <!-- Hidden fields -->
                <input type="hidden" id="autoNumber" name="autoNumber">
                <input type="hidden" id="timestamp" name="timestamp">

                <div id="error-message" class="error-message" style="color: red;"></div>


                <!-- Buttons -->
                <div class="btn-container">
                    <button type="button" class="btn-primary" onclick="saveData()">
                        <i class="fas fa-save"></i> שמירת נתונים
                    </button>
                    <button type="button" class="btn-secondary"
                        onclick="document.getElementById('file-input').click();">
                        <i class="fas fa-upload"></i> העלאת מסמכים
                    </button>
                    <button type="button" class="btn-secondary" onclick="printData()">
                        <i class="fas fa-print"></i> הדפסה
                    </button>
                    <button type="button" class="btn-secondary" onclick="exportToPDF()">
                        <i class="fas fa-file-pdf"></i> ייצוא PDF
                    </button>
                    <button type="button" class="btn-secondary" onclick="exportToExcel()">
                        <i class="fas fa-file-excel"></i> ייצוא EXCEL
                    </button>
                    <button type="button" class="btn-secondary" onclick="clearFields()">
                        <i class="fas fa-eraser"></i> ניקוי
                    </button>
                    <button type="button" class="btn-danger" onclick="exit()">
                        <i class="fas fa-sign-out-alt"></i> יציאה
                    </button>
                </div>
            </form>
        </div>

        <!-- ---------------------------------------------------- -->

        <div class="card" id="documents-area">
            <h2><i class="fas fa-folder-open"></i>מסמכים נלווים</h2>
            <table id="documentsTable">
                <thead>
                    <tr>
                        <th>שם מסמך</th>
                        <th>תאריך הוספה</th>
                        <th>פעולה</th>
                    </tr>
                </thead>
                <tbody id="documents-body">
                    <td><button onclick="deleteDocument()">מחק</button></td>

                </tbody>
            </table>
        </div>




        <div class="card hidden" id="document-display-area">
            <h2>
                <i class="fas fa-file-alt"></i>
                <span id="preview-document-name">תצוגה מקדימה של מסמך</span>
                <button class="action-btn" onclick="closePreview()" style="margin-right: auto;">
                    <i class="fas fa-times"></i>
                </button>
            </h2>
            <iframe id="document-viewer" width="100%" height="500px"></iframe>
        </div>

        <div class="section" id="reshumotList">
            <h2>רשומות</h2>
        </div>

        <div id="formContainer"></div> <!-- הוספת אלמנט זה -->

        <input type="file" id="file-input" style="display: none;" onchange="handleFileUpload(event)">

    </div>

    <script>
        function getData() {
            getReshumot();
            getMaam();
            loadDocuments();

        }
        function calculateVAT() {
            const amount = document.getElementById('amount').value;
            let maam = document.getElementById('maam_id').value;
            maam = maam / 100;
            const vat = amount * maam; // לדוגמה, מע"מ 17%
            document.getElementById('scmaan').value = vat;
            document.getElementById('totalAmount').value = parseFloat(amount) + vat;
        }

        function validateForm() {
            const department = document.getElementById("department").value;
            const supplierName = document.getElementById("supplierName").value;
            const amount = document.getElementById("amount").value;
            const deliveryPlace = document.getElementById("deliveryPlace").value;
            const agentNumber = document.getElementById("agentNumber").value;
            const contactName = document.getElementById("contactName").value;
            const contactPhone = document.getElementById("contactPhone").value;
            const contactEmail = document.getElementById("contactEmail").value;
            const projectName = document.getElementById("projectName").value;
            const budgetItem = document.getElementById("budgetItem").value;

            // נקה הודעות שגיאה קודמות
            clearErrorMessages();

            let isValid = true;

            if (!department) {
                document.getElementById("error-department").innerText = "מחלקה היא שדה חובה.";
                isValid = false;
            }

            if (!supplierName) {
                document.getElementById("error-supplierName").innerText = "יש לבחור ספק.";
                isValid = false;
            }

            if (!amount || amount <= 0) {
                document.getElementById("error-amount").innerText = "סכום חייב להיות חיובי.";
                isValid = false;
            }

            if (!deliveryPlace) {
                document.getElementById("error-deliveryPlace").innerText = "מקום אספקה הוא שדה חובה.";
                isValid = false;
            }

            if (!agentNumber) {
                document.getElementById("error-agentNumber").innerText = "מס סוכן הוא שדה חובה.";
                isValid = false;
            }

            if (!contactName) {
                document.getElementById("error-contactName").innerText = "שם סוכן הוא שדה חובה.";
                isValid = false;
            }

            if (!validatePhone(contactPhone)) {
                document.getElementById("error-contactPhone").innerText = "טלפון סוכן לא תקין.";
                isValid = false;
            }

            if (!validateEmail(contactEmail)) {
                document.getElementById("error-contactEmail").innerText = "מייל סוכן לא תקין.";
                isValid = false;
            }

            if (!projectName) {
                document.getElementById("error-projectName").innerText = "שם פרויקט הוא שדה חובה.";
                isValid = false;
            }

            if (budgetItem === "" || budgetItem < 0 || budgetItem == 0) {
                document.getElementById("error-budgetItem").innerText = "תקציב חייב להיות מספר חיובי.";
                isValid = false;
            }

            return isValid; // מחזיר true אם כל הבדיקות עברו
        }

        function validateEmail(email) {
            const regex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return regex.test(email);
        }

        function validatePhone(phone) {
            const regex = /^\d{10}$/; // בדיקה לפורמט טלפון של 10 ספרות
            return regex.test(phone);
        }

        function clearErrorMessages() {
            const errorIds = [
                "error-department",
                "error-supplierName",
                "error-amount",
                "error-deliveryPlace",
                "error-agentNumber",
                "error-contactName",
                "error-contactPhone",
                "error-contactEmail",
                "error-projectName",
                "error-budgetItem"
            ];

            errorIds.forEach(id => {
                document.getElementById(id).innerText = "";
            });
        }

        // הוסף מאזיני אירועים לכל שדה
        document.querySelectorAll('input, select').forEach(element => {
            element.addEventListener('input', clearErrorMessages);
        });


        function clearErrorMessages() {
            const errorIds = [
                "error-department",
                "error-supplierName",
                "error-amount",
                "error-deliveryPlace",
                "error-agentNumber",
                "error-contactName",
                "error-contactPhone",
                "error-contactEmail",
                "error-projectName",
                "error-budgetItem"
            ];

            errorIds.forEach(id => {
                document.getElementById(id).innerText = "";
            });
        }

        // הוסף מאזיני אירועים לכל שדה
        document.querySelectorAll('input, select').forEach(element => {
            element.addEventListener('input', clearErrorMessages);
        });



        // פונקציה לבדוק אם המייל תקין
        function validateEmail(email) {
            const regex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return regex.test(email);
        }

        // עדכון הפונקציה לשמירת נתונים

        function clearFields() {
            // Check if elements exist before trying to set their value
            if (document.getElementById('autoNumber')) document.getElementById('autoNumber').value = '';
            if (document.getElementById('timestamp')) document.getElementById('timestamp').value = '';
            if (document.getElementById('department')) document.getElementById('department').value = '';
            if (document.getElementById('supplierName')) document.getElementById('supplierName').value = 'ספק 1';
            // Remove or replace this line since requiredDate doesn't exist
            // if (document.getElementById('requiredDate')) document.getElementById('requiredDate').value = '';
            if (document.getElementById('amount')) document.getElementById('amount').value = '';
            // Change 'vat' to 'maam_id' since that's what's in your HTML
            // if (document.getElementById('maam_id')) document.getElementById('maam_id').value = '';
            if (document.getElementById('scmaan')) document.getElementById('scmaan').value = '';
            if (document.getElementById('totalAmount')) document.getElementById('totalAmount').value = '';
            if (document.getElementById('deliveryPlace')) document.getElementById('deliveryPlace').value = '';
            if (document.getElementById('contactName')) document.getElementById('contactName').value = '';
            if (document.getElementById('contactPhone')) document.getElementById('contactPhone').value = '';
            if (document.getElementById('contactEmail')) document.getElementById('contactEmail').value = '';
            if (document.getElementById('projectName')) document.getElementById('projectName').value = '';
            if (document.getElementById('agentNumber')) document.getElementById('agentNumber').value = '';
            if (document.getElementById('budgetItem')) document.getElementById('budgetItem').value = '';

            // If you have a checkbox for exempt, you might want to uncheck it
            if (document.getElementById('exempt')) document.getElementById('exempt').checked = false;
        }


        function clearField(fieldId) {
            document.getElementById(fieldId).value = '';
        }

        function printData() {
            window.print();
        }

        function exit() {
            window.location.href = 'login.html'; // דף הלוגאין
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    const content = e.target.result;
                    const rows = content.split('\n').map(row => row.split(','));
                    const headers = rows[0].map(header => header.trim());
                    const data = rows[1].map(value => value.trim());
                    const expectedFields = [
                        "Record Number", "Timestamp", "Department", "Supplier Name", "Amount",
                        "VAT", "Total Amount", "Delivery Location", "Contact Name",
                        "Contact Phone", "Contact Email", "Project Name", "Agent Number", "Budget Item"
                    ];
                    if (headers.length !== expectedFields.length) {
                        showNotification("הקובץ שהועלה אינו תואם לשדות הדרושים");
                        return;
                    }

                    for (let i = 0; i < headers.length; i++) {
                        const fieldId = headers[i].toLowerCase().replace(/ /g, '-');
                        if (document.getElementById(fieldId)) {
                            document.getElementById(fieldId).value = data[i];
                        }
                    }
                    showNotification("הקובץ הועלה ויובאו נתונים בהצלחה!");
                };
                reader.readAsText(file);
            }
            event.target.value = '';
        }

        function showNotification(message, type = 'info') {
            const existingNotifications = document.querySelectorAll('.notification');
            existingNotifications.forEach(notification => {
                notification.remove();
            });

            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            let icon = 'info-circle';
            if (type === 'success') {
                icon = 'check-circle';
            } else if (type === 'error') {
                icon = 'exclamation-circle';
            }
            notification.innerHTML = `
                <div class="notification-icon">
                    <i class="fas fa-${icon}"></i>
                </div>
                <div class="notification-message">${message}</div>
                <button class="notification-close" onclick="this.parentElement.remove()">
                    <i class="fas fa-times"></i>
                </button>
            `;
            document.body.appendChild(notification);
            setTimeout(() => {
                notification.classList.add('show');
            }, 10);
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.classList.remove('show');
                    setTimeout(() => {
                        if (notification.parentElement) {
                            notification.remove();
                        }
                    }, 300);
                }
            }, 5000);
        }


        function deleteDocument() {
            alert("המסמך נמחק.");
        }

        async function getMaam() {
            try {
                const maam = await listAllMaam();

                // Log the object properly without string concatenation
                console.log("Maam data:", maam);

                // Check if maam data exists and has at least one entry
                if (maam && maam.length > 0 && maam[0].maam_value) {
                    // Update the VAT percentage field with the value from maam[0].maam_v
                    const vatPercentage = maam[0].maam_value;
                    document.getElementById('maam_id').value = vatPercentage;

                    // If amount is already entered, recalculate the VAT amount
                    const amount = document.getElementById('amount').value;
                }

                return maam;
            } catch (error) {
                console.error("Error fetching maam data:", error);
                return null;
            }
        }

        function exportToPDF() {
            const element = document.querySelector('.container');
            html2pdf()
                .from(element)
                .save('purchase_request.pdf')
                .then(() => {
                    showNotification('הקובץ PDF יוצא בהצלחה!');
                });
        }

        function exportToExcel() {
            const data = [
                ['Record Number', 'Timestamp', 'Department', 'Supplier Name', 'Amount', 'VAT', 'Total Amount', 'Delivery Location', 'Contact Name', 'Contact Phone', 'Contact Email', 'Project Name', 'Agent Number', 'Budget Item'],
                [
                    document.getElementById('autoNumber').value,
                    document.getElementById('timestamp').value,
                    document.getElementById('department').value,
                    document.getElementById('supplierName').value,
                    document.getElementById('amount').value,
                    document.getElementById('vat').value,
                    document.getElementById('totalAmount').value,
                    document.getElementById('deliveryPlace').value,
                    document.getElementById('contactName').value,
                    document.getElementById('contactPhone').value,
                    document.getElementById('contactEmail').value,
                    document.getElementById('projectName').value,
                    document.getElementById('agentNumber').value,
                    document.getElementById('budgetItem').value
                ]
            ];

            let csvContent = "data:text/csv;charset=utf-8," + data.map(e => e.join(",")).join("\n");

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "purchase_request.csv");
            document.body.appendChild(link);
            link.click(); // יוצר את ההורדה אוטומטית
            document.body.removeChild(link); // מסיר את הלינק לאחר ההורדה
        }



        async function saveData() {
            if (validateForm()) {

                const recordId = document.getElementById('autoNumber').value;

                // Fetch all records to check if the record already exists
                const records = await listAllReshumot();
                const existingRecord = records.find(record => record.Rsh_id === recordId);

                const data = {
                    Rsh_id: recordId,
                    Rsh_date: document.getElementById('timestamp').value,
                    Rsh_mchlaka: document.getElementById('department').value,
                    Rsh_sapak: document.getElementById('supplierName').value,
                    Rsh_patoor: document.getElementById('exempt').checked ? '1' : '0', // Use the checkbox value
                    Rsh_schoom: document.getElementById('amount').value,
                    Rsh_maam: document.getElementById('maam_id').value, // Changed from 'vat' to 'maam_id'
                    Rsh_schmaam: document.getElementById('scmaan').value, // Changed from 'totalAmount' to 'scmaan'
                    Rsh_schtotal: document.getElementById('totalAmount').value,
                    Rsh_aspaka: document.getElementById('deliveryPlace').value, // Changed from 'contactName' to 'deliveryPlace'
                    Rsh_proyktnam: document.getElementById('projectName').value,
                    Rsh_status: document.getElementById('contactEmail').value,
                    Rsh_sochen: document.getElementById('contactName').value, // Changed from 'contactPhone' to 'contactName'
                    Rsh_takziv: document.getElementById('budgetItem').value, // Changed from 'agentNumber' to 'budgetItem'
                    Rsh_cname: document.getElementById('contactName').value, // Changed from 'budgetItem' to 'contactName'
                    // Rsh_cnametl: document.getElementById('contactPhone').value, // Added this field

                    // שדות אחרים
                    Rsh_cnametl: document.getElementById('contactPhone').value ? '0' + document.getElementById('contactPhone').value : '', // הוספת 0 בהתחלה
                    // שדות אחרים
                    Rsh_cemail: document.getElementById('contactEmail').value
                };

                console.log('Data to save:', data);
                try {
                    if (existingRecord) {
                        // If record exists, update it
                        const response = await updateReshumot(data);
                        console.log('Server response:', response);
                        if (response.message === "Reshumot updated successfully") {
                            showNotification('רשומה עודכנה בהצלחה!');
                            getReshumot()
                            // location.reload();
                        }
                    } else {
                        // If record does not exist, create it
                        const response = await createReshumot(data);
                        console.log('Server response:', response);
                        if (response.message === "Reshumot created successfully") {
                            showNotification('רשומה נשמרה בהצלחה!');
                            getReshumot()
                            // location.reload();
                        }

                        // showNotification('רשומה נשמרה בהצלחה!');
                    }
                    clearFields(); // Clear fields after saving
                } catch (error) {
                    console.error('Error saving Reshuma:', error);
                    console.error('Error details:', error.message);
                    if (error.response) {
                        console.error('Response data:', error.response.data);
                        console.error('Response status:', error.response.status);
                    }
                    // showNotification('שגיאה בשמירת רשומה!', 'error');
                }
            }

        }

        // פונקציה לניהול הרשאות
        // setTimeout(() => {
        //     alert("אין פעילות בדף, תתבצע יציאה אוטומטית.");
        //     exit();
        // }, 600000); // 10 דקות

        // פונקציה לטעינת רשומות
        async function getReshumot() {
            try {
                let reshumot;
                try {
                    reshumot = await listAllReshumot();
                    console.log('Received reshumot data:', reshumot);
                    fillForm(reshumot);
                } catch (e) {
                    console.error('Error calling listAllReshumot:', e);
                    reshumotListDiv.innerHTML = '<p>Error fetching data: ' + e.message + '</p>';
                    return;
                }

                if (!reshumot) {
                    console.warn('Reshumot data is null or undefined');
                    reshumotListDiv.innerHTML = '<p>No data available</p>';
                    return;
                }

            } catch (error) {
                console.error('Error in getReshumot function:', error);
                const reshumotListDiv = document.getElementById('reshumotList');
                if (reshumotListDiv) {
                    reshumotListDiv.innerHTML = '<p>Error loading data: ' + error.message + '</p>';
                }
            }
        }

        window.onload = function () {
            initializeForm();
            try {
                getData();
            } catch (error) {
                console.error('Error in getData:', error);
                const reshumotListDiv = document.getElementById('reshumotList');
                if (reshumotListDiv) {
                    reshumotListDiv.innerHTML = '<p>Failed to load data</p>';
                }
            }
        };

        function initializeForm() {
            const now = new Date();
            if (document.getElementById('timestamp')) {
                document.getElementById('timestamp').value = now.toLocaleString();
            }

            if (document.getElementById('autoNumber')) {
                document.getElementById('autoNumber').value = 'AUTO-' + Math.floor(Math.random() * 10000);
            }

            const formFields = document.querySelectorAll('#documentForm input, #documentForm select');
            formFields.forEach(field => {
                if (field.type === 'number' && !field.value) {
                    field.value = '0';
                }
            });
        }


        /*************  ✨ Codeium Command ⭐  *************/
        /**
         * Populates a form container with record data in a card format.
         *
         * This function clears any existing content in the form container and
         * creates a card for each record in the `data` array. Each card displays
         * the record's details, including its title and data fields, using a
         * pre-defined mapping for Hebrew field names. The cards also feature 
         * hover effects for aesthetic purposes.
         *
         * Each card includes action buttons for editing and deleting the record. 
         * Clicking the edit button loads the record's data into the form for 
         * modification. Clicking the delete button prompts the user for 
         * confirmation before attempting to delete the record.
         *
         * If there are no records to display, a message is shown instead.
         *
         * @param {Array} data - An array of record objects to be displayed.
         *                       Each object should contain key-value pairs
         *                       corresponding to specific record fields.
         */

        /******  4a975f3d-9e10-412d-9de6-aad31a4f7e06  *******/
        function fillForm(data) {
            const formContainer = document.getElementById('formContainer');
            formContainer.innerHTML = ''; // Clear previous content

            const titleMapping = {
                'Rsh_id': 'מספר רשומה',
                'Rsh_date': 'תאריך',
                'Rsh_mchlaka': 'מחלקה',
                'Rsh_sapak': 'ספק',
                'Rsh_patoor': 'פטור',
                'Rsh_schoom': 'סכום',
                'Rsh_maam': 'מע"מ',
                'Rsh_schmaam': 'סכום מע"מ',
                'Rsh_schtotal': 'סכום כולל',
                'Rsh_aspaka': 'מקום אספקה',
                'Rsh_proyktnam': 'שם פרויקט',
                'Rsh_status': 'סטטוס',
                'Rsh_sochen': 'סוכן',
                'Rsh_takziv': 'תקציב',
                'Rsh_cname': 'שם סוכן',
                'Rsh_cnametl': 'טלפון סוכן',
                'Rsh_cemail': 'מייל סוכן'
            };

            // Create a styled container for the records
            const recordsContainer = document.createElement('div');
            recordsContainer.className = 'records-container';
            recordsContainer.style.display = 'flex';
            recordsContainer.style.flexWrap = 'wrap';
            recordsContainer.style.gap = '20px';
            recordsContainer.style.justifyContent = 'center';

            data.forEach((item, index) => {
                // Create a card for each record
                const recordCard = document.createElement('div');
                recordCard.className = 'record-card';
                recordCard.style.border = '1px solid #ddd';
                recordCard.style.borderRadius = '8px';
                recordCard.style.padding = '15px';
                recordCard.style.boxShadow = '0 4px 8px rgba(0,0,0,0.1)';
                recordCard.style.backgroundColor = '#f9f9f9';
                recordCard.style.width = '300px';
                recordCard.style.margin = '10px';
                recordCard.style.transition = 'transform 0.3s ease';
                recordCard.style.cursor = 'pointer';

                // Add hover effect
                recordCard.onmouseover = function () {
                    this.style.transform = 'translateY(-5px)';
                    this.style.boxShadow = '0 6px 12px rgba(0,0,0,0.15)';
                };
                recordCard.onmouseout = function () {
                    this.style.transform = 'translateY(0)';
                    this.style.boxShadow = '0 4px 8px rgba(0,0,0,0.1)';
                };

                // Add card header with record number
                const cardHeader = document.createElement('div');
                cardHeader.className = 'card-header';
                cardHeader.style.borderBottom = '1px solid #eee';
                cardHeader.style.marginBottom = '10px';
                cardHeader.style.paddingBottom = '10px';
                cardHeader.style.textAlign = 'center';

                const recordTitle = document.createElement('h3');
                recordTitle.textContent = `רשומה ${index + 1}`;
                recordTitle.style.margin = '0';
                recordTitle.style.color = '#2c3e50';
                cardHeader.appendChild(recordTitle);
                recordCard.appendChild(cardHeader);

                // Create a list for the record details
                const detailsList = document.createElement('ul');
                detailsList.style.listStyleType = 'none';
                detailsList.style.padding = '0';
                detailsList.style.margin = '0';

                // Add each field as a list item
                for (const key in item) {
                    if (item.hasOwnProperty(key) && titleMapping[key]) {
                        const listItem = document.createElement('li');
                        listItem.style.padding = '5px 0';
                        listItem.style.borderBottom = '1px dashed #eee';

                        const fieldLabel = document.createElement('strong');
                        fieldLabel.textContent = titleMapping[key] + ': ';
                        fieldLabel.style.color = '#3498db';

                        const fieldValue = document.createElement('span');
                        fieldValue.textContent = item[key] || 'לא צוין';

                        listItem.appendChild(fieldLabel);
                        listItem.appendChild(fieldValue);
                        detailsList.appendChild(listItem);
                    }
                }

                recordCard.appendChild(detailsList);

                // Add action buttons
                const actionDiv = document.createElement('div');
                actionDiv.className = 'record-actions';
                actionDiv.style.marginTop = '15px';
                actionDiv.style.display = 'flex';
                actionDiv.style.justifyContent = 'space-around';

                const editButton = document.createElement('button');
                editButton.textContent = 'עריכה';
                editButton.className = 'btn-secondary';
                editButton.style.padding = '5px 10px';
                editButton.style.borderRadius = '4px';
                editButton.style.cursor = 'pointer';
                editButton.onclick = function () {
                    // Load this record data into the form for editing
                    loadRecordToForm(item);
                };

                const deleteButton = document.createElement('button');
                deleteButton.textContent = 'מחיקה';
                deleteButton.className = 'btn-danger';
                deleteButton.style.padding = '5px 10px';
                deleteButton.style.borderRadius = '4px';
                deleteButton.style.cursor = 'pointer';
                deleteButton.onclick = async function () {
                    const result = await Swal.fire({
                        title: 'אישור מחיקה',
                        text: 'האם אתה בטוח שברצונך למחוק רשומה זו?',
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonColor: '#d33',
                        cancelButtonColor: '#3085d6',
                        confirmButtonText: 'כן, מחק את זה!',
                        cancelButtonText: 'לא, ביטול'
                    });

                    if (result.isConfirmed) {
                        // Delete record functionality would go here
                        const res = await deleteReshumot(item.Rsh_id);
                        if (res.message === "Reshumot deleted successfully") {
                            recordCard.remove();
                            showNotification('הרשומה נמחקה בהצלחה');
                        } else {
                            showNotification('שגיאה במחיקת הרשומה');
                        }
                    }
                };


                actionDiv.appendChild(editButton);
                actionDiv.appendChild(deleteButton);
                recordCard.appendChild(actionDiv);

                recordsContainer.appendChild(recordCard);
            });

            formContainer.appendChild(recordsContainer);

            // Add a helper function to load record data into the form
            function loadRecordToForm(record) {
                // Set form values from the record
                if (document.getElementById('autoNumber')) document.getElementById('autoNumber').value = record.Rsh_id || '';
                if (document.getElementById('timestamp')) {
                    const dateValue = record.Rsh_date || '';
                    if (dateValue) {
                        const date = new Date(dateValue);
                        // פורמט התאריך לדוגמה: DD/MM/YYYY
                        const options = { day: '2-digit', month: '2-digit', year: 'numeric' };
                        const formattedDate = date.toLocaleDateString('he-IL', options);
                        document.getElementById('timestamp').value = formattedDate;
                    } else {
                        document.getElementById('timestamp').value = '';
                    }
                }

                if (document.getElementById('department')) document.getElementById('department').value = record.Rsh_mchlaka || '';
                if (document.getElementById('supplierName')) document.getElementById('supplierName').value = record.Rsh_sapak || '';
                if (document.getElementById('exempt')) document.getElementById('exempt').checked = record.Rsh_patoor === '1';
                if (document.getElementById('amount')) document.getElementById('amount').value = record.Rsh_schoom || '';
                if (document.getElementById('maam_id')) document.getElementById('maam_id').value = record.Rsh_maam || '';
                if (document.getElementById('scmaan')) document.getElementById('scmaan').value = record.Rsh_schmaam || '';
                if (document.getElementById('totalAmount')) document.getElementById('totalAmount').value = record.Rsh_schtotal || '';
                if (document.getElementById('deliveryPlace')) document.getElementById('deliveryPlace').value = record.Rsh_aspaka || '';
                if (document.getElementById('projectName')) document.getElementById('projectName').value = record.Rsh_proyktnam || '';
                if (document.getElementById('contactEmail')) document.getElementById('contactEmail').value = record.Rsh_status || '';
                if (document.getElementById('contactName')) document.getElementById('contactName').value = record.Rsh_cname || '';
                if (document.getElementById('contactPhone')) document.getElementById('contactPhone').value = record.Rsh_cnametl || '';
                if (document.getElementById('budgetItem')) document.getElementById('budgetItem').value = record.Rsh_takziv || '';

                // Scroll to the form
                document.getElementById('input-form').scrollIntoView({ behavior: 'smooth' });

                showNotification('הרשומה נטענה לעריכה', 'info');
            }

            // If no data, show a message
            if (data.length === 0) {
                const noDataMsg = document.createElement('div');
                noDataMsg.style.textAlign = 'center';
                noDataMsg.style.padding = '20px';
                noDataMsg.style.color = '#7f8c8d';
                noDataMsg.innerHTML = '<i class="fas fa-info-circle"></i> אין רשומות להצגה';
                formContainer.appendChild(noDataMsg);
            }
        }

        window.addEventListener('beforeunload', function () {
            updateUser(localStorage.getItem('userId'),
                {
                    Lg_timestmpiout: new Date().toLocaleString('sv-SE'),
                    Lg_status: 0
                }
            );
        });
        document.addEventListener('DOMContentLoaded', function () {
            // Try to load mnilvim
            if (typeof listAllMnilvim === 'function') {
                listAllMnilvim()
                    .then(documents => {
                        console.log('Documents loaded:', documents); // לוג של המסמכים שהוטענו
                        const tableBody = document.getElementById('documents-body');
                        tableBody.innerHTML = ''; // ניקוי התוכן הקיים

                        if (!documents || documents.length === 0) {
                            const row = tableBody.insertRow();
                            const cell = row.insertCell(0);
                            cell.colSpan = 7; // עדכון למספר השדות
                            cell.style.textAlign = 'center';
                            cell.textContent = 'No documents available';
                            return;
                        }

                        documents.forEach(doc => {
                            const row = tableBody.insertRow();

                            const idCell = row.insertCell(0);
                            idCell.textContent = doc.MN_id || 'N/A'; // הנחה שיש שדה בשם 'MN_id'

                            const pratimCell = row.insertCell(1);
                            pratimCell.textContent = doc.MN_pratim || 'N/A'; // הנחה שיש שדה בשם 'MN_pratim'

                            const locationCell = row.insertCell(2);
                            locationCell.textContent = doc.MN_location || 'N/A'; // הנחה שיש שדה בשם 'MN_location'

                            const MN_shyoochCell = row.insertCell(3);
                            idCell.textContent = doc.MN_shyooch || 'N/A'; // הנחה שיש שדה בשם 'MN_id'

                            const MN_statusCell = row.insertCell(4);
                            pratimCell.textContent = doc.MN_status || 'N/A'; // הנחה שיש שדה בשם 'MN_pratim'

                            const MN_dateAddCell = row.insertCell(5);
                            locationCell.textContent = doc.MN_dateAdd || 'N/A'; // הנחה שיש שדה בשם 'MN_location'

                            const MN_typeCell = row.insertCell(6);
                            locationCell.textContent = doc.MN_type || 'N/A'; // הנחה שיש שדה בשם 'MN_location'

                            // הוספת כפתורים לפעולות (אם יש צורך)
                            const actionsCell = row.insertCell(6);
                            const viewBtn = document.createElement('button');
                            viewBtn.className = 'action-btn';
                            viewBtn.innerHTML = '<i class="fas fa-eye"></i>';
                            viewBtn.title = 'View Document';
                            viewBtn.onclick = function () {
                                // הוסף כאן את הלוגיקה להצגת המסמך אם יש צורך
                            };
                            actionsCell.appendChild(viewBtn);

                            const deleteBtn = document.createElement('button');
                            deleteBtn.className = 'action-btn';
                            deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
                            deleteBtn.title = 'Delete Document';
                            deleteBtn.onclick = function () {
                                Swal.fire({
                                    title: 'Are you sure?',
                                    text: "You won't be able to revert this!",
                                    icon: 'warning',
                                    showCancelButton: true,
                                    confirmButtonColor: '#d33',
                                    cancelButtonColor: '#3085d6',
                                    confirmButtonText: 'Yes, delete it!'
                                }).then((result) => {
                                    if (result.isConfirmed) {
                                        // הוסף כאן קוד למחיקת המסמך מהשרת
                                        Swal.fire('Deleted!', 'Your document has been deleted.', 'success');
                                        loadDocuments(); // טען מחדש את המסמכים
                                    }
                                });
                            };
                            actionsCell.appendChild(deleteBtn);
                        });
                    })
                    .catch(error => {
                        console.error('Error loading documents:', error);
                        showNotification('Failed to load documents', 'error');
                    });
            } else {
                console.error('listAllMnilvim function is not available');
            }
            checkPR();
            if (document.referrer.includes("login")) {
                updateUser(localStorage.getItem('userId'), {
                    Lg_timestmpin: new Date().toLocaleString('sv-SE'),
                    Lg_status: 1
                });
            }
        });

        function checkPR() {

            if (localStorage.getItem('PR') === '2') {
                document.getElementById('conditionalButton').style.display = 'block';
            } else {
                document.getElementById('conditionalButton').style.display = 'none';
            }
        }

        function goToAdmin() {
            window.location.href = 'admin.html';
        }


        function closePreview() {
            document.getElementById('document-display-area').classList.add('hidden');
        }
        async function fetchDocument(url, type) {
            const viewer = document.getElementById('document-viewer');
            const displayArea = document.getElementById('document-display-area');

            // הצג את אזור התצוגה המקדימה
            displayArea.classList.remove('hidden');

            console.log("Fetching document:", url, "Type:", type);

            // בדיקה אם זה קובץ Word
            if (type.toLowerCase() === 'word' || type.toLowerCase() === 'doc' || type.toLowerCase() === 'docx' || url.toLowerCase().endsWith('.docx') || url.toLowerCase().endsWith('.doc')) {
                // עבור קבצי Word, נציג דף עם אפשרויות להורדה או פתיחה
                viewer.srcdoc = `
            <html>
            <head>
                <style>
                    body {
                        font-family: Arial, sans-serif;
                        text-align: center;
                        padding: 20px;
                        direction: rtl;
                        background-color: #f5f5f5;
                    }
                    .container {
                        max-width: 500px;
                        margin: 0 auto;
                        background-color: white;
                        padding: 30px;
                        border-radius: 8px;
                        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                    }
                    h2 {
                        color: #333;
                        margin-bottom: 20px;
                    }
                    p {
                        color: #666;
                        margin-bottom: 25px;
                    }
                    .button {
                        display: inline-block;
                        margin: 10px;
                        padding: 12px 24px;
                        background-color: #4285f4;
                        color: white;
                        text-decoration: none;
                        border-radius: 4px;
                        font-weight: bold;
                        transition: background-color 0.3s;
                    }
                    .button:hover {
                        background-color: #3367d6;
                    }
                </style>
            </head>
            <body>
                <div class="container">
                    <h2>מסמך Word</h2>
                    <p>לא ניתן להציג תצוגה מקדימה של מסמך Word ישירות בדפדפן.</p>
                    <a href="${url}" download class="button">הורד את המסמך</a>
                </div>
            </body>
            </html>
        `;
            } else if (type.toLowerCase() === 'pdf' || url.toLowerCase().endsWith('.pdf')) {
                // PDF יכול להיות מוצג ישירות
                viewer.src = url;
            } else {
                // עבור סוגי קבצים אחרים
                viewer.srcdoc = `
            <html>
            <head>
                <style>
                    body {
                        font-family: Arial, sans-serif;
                        text-align: center;
                        padding: 20px;
                        direction: rtl;
                        background-color: #f5f5f5;
                    }
                    .container {
                        max-width: 500px;
                        margin: 0 auto;
                        background-color: white;
                        padding: 30px;
                        border-radius: 8px;
                        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                    }
                    h2 {
                        color: #333;
                        margin-bottom: 20px;
                    }
                    p {
                        color: #666;
                        margin-bottom: 25px;
                    }
                    .button {
                        display: inline-block;
                        margin: 10px;
                        padding: 12px 24px;
                        background-color: #4285f4;
                        color: white;
                        text-decoration: none;
                        border-radius: 4px;
                        font-weight: bold;
                        transition: background-color 0.3s;
                    }
                    .button:hover {
                        background-color: #3367d6;
                    }
                </style>
            </head>
            <body>
                <div class="container">
                    <h2>הורדת קובץ</h2>
                    <p>לא ניתן להציג תצוגה מקדימה של קובץ מסוג זה.</p>
                    <a href="${url}" download class="button">הורד את הקובץ</a>
                </div>
            </body>
            </html>
        `;
            }
        }


        async function loadDocuments() {
            // document.getElementById('documents-loading').classList.remove('hidden');
            document.getElementById('documentsTable').classList.add('hidden');
            // document.getElementById('empty-documents').classList.add('hidden');


            const documents = await listAllMnilvim(); // קריאה לשרת
            // document.getElementById('documents-loading').classList.add('hidden');

            const tbody = document.getElementById('documents-body');
            tbody.innerHTML = ''; // ניקוי התוכן הקודם

            documents.forEach(doc => {
                const row = document.createElement('tr');
                row.innerHTML = `
                <td>${doc.MN_pratim}</td>
                <td>${doc.MN_dateAdd}</td>
                <td><button onclick="deleteDocument('${doc.MN_id}')">מחק</button></td>
            `;
                row.onclick = () => fetchDocument(doc.MN_location, doc.MN_type); // תצוגה מקדימה
                tbody.appendChild(row);
            });
        }
        async function deleteDocument(id) {
            // כאן תוסיף את הקוד למחיקת המסמך מהשרת
            alert(`מסמך עם ID ${id} נמחק!`);
            loadDocuments(); // טען מחדש את המסמכים
        }

    </script>
</body>

</html>