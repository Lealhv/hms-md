<!DOCTYPE html>
<html lang="he">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>מערכת ניהול מסמכים</title>
    <style>
        body {
            font-family: Arial, sans-serif;
        }

        .container {
            width: 80%;
            margin: auto;
        }

        .section {
            margin: 20px 0;
            padding: 10px;
            border: 1px solid #ccc;
        }
    </style>
    <script src="services/reshumot.server.js" defer></script>
    <script src="services/mnilvim.server.js" defer></script>

</head>

<body onload="getReshumot()">
    <div class="container">
        <div class="section" id="header">
            <h1>מערכת ניהול מסמכים</h1>
            <p>ברוכים הבאים למערכת לניהול מסמכים.</p>
            <button id="conditionalButton" class="btn" onclick="goToAdmin()">לעמוד מנהל</button>
        </div>

        <div class="section" id="input-form">
            <h2>טופס קלט</h2>
            <form id="documentForm">
                <label for="autoNumber">מס סודר אוטומטי:</label>
                <input type="text" id="autoNumber" name="autoNumber" readonly><br>

                <label for="timestamp">חתימת זמן אוטומטית:</label>
                <input type="text" id="timestamp" name="timestamp" readonly><br>

                <label for="department">מחלקה:</label>
                <input type="text" id="department" name="department"><br>

                <label for="supplierName">שם הספק:</label>
                <select id="supplierName" name="supplierName">
                    <option value="ספק 1">ספק 1</option>
                    <option value="ספק 2">ספק 2</option>
                </select><br>

                <label for="requiredDate">תאריך נדרש:</label>
                <input type="date" id="requiredDate" name="requiredDate"><br>

                <label for="amount">סכום:</label>
                <input type="number" id="amount" name="amount" oninput="calculateVAT()"><br>

                <label for="vat">מע"מ:</label>
                <input type="number" id="vat" name="vat" readonly><br>

                <label for="exempt">עוסק פטור:</label>
                <input type="checkbox" id="exempt" name="exempt"><br>

                <label for="totalAmount">סכום כולל:</label>
                <input type="number" id="totalAmount" name="totalAmount" readonly><br>

                <label for="deliveryPlace">מקום אספקה:</label>
                <input type="text" id="deliveryPlace" name="deliveryPlace"><br>

                <label for="contactName">שם איש הקשר:</label>
                <input type="text" id="contactName" name="contactName"><br>

                <label for="contactPhone">טלפון איש קשר:</label>
                <input type="text" id="contactPhone" name="contactPhone"><br>

                <label for="contactEmail">מייל איש קשר:</label>
                <input type="email" id="contactEmail" name="contactEmail"><br>

                <label for="projectName">שם פרויקט:</label>
                <input type="text" id="projectName" name="projectName"><br>

                <label for="agentNumber">מס סוכן:</label>
                <input type="text" id="agentNumber" name="agentNumber"><br>

                <label for="budgetItem">סעיף תקציבי:</label>
                <input type="text" id="budgetItem" name="budgetItem"><br>

                <button type="button" onclick="clearFields()">ניקוי שדות הכל</button>
                <button type="button" onclick="saveData()">שמירת נתונים</button>
                <button type="button" onclick="printData()">הדפסה</button>
                <button type="button" onclick="exit()">יציאה</button>
            </form>
        </div>

<!-- ---------------------------------------------------- -->
<div class="card" id="documents-area">
    <h2><i class="fas fa-folder-open"></i>מסמכים נלווים</h2>
    <table id="documentsTable">
        <thead>
            <tr>
                <th>שם מסמך</th>
                <th>תאריך הוספה</th>
                <th>פעולה</th>
            </tr>
        </thead>
        <tbody id="documents-body">
            <td><button onclick="deleteDocument()">מחק</button></td>

        </tbody>
    </table>
</div>

<div class="card hidden" id="document-display-area">
    <h2>
        <i class="fas fa-file-alt"></i> 
        <span id="preview-document-name">תצוגה מקדימה של מסמך</span>
        <button class="action-btn" onclick="closePreview()" style="margin-right: auto;">
            <i class="fas fa-times"></i>
        </button>
    </h2>
    <iframe id="document-viewer" width="100%" height="500px"></iframe>
</div>

        <!---------------------------------------------  -->
                


        <!-- <div class="card" id="documents-area">
            <h2><i class="fas fa-folder-open"></i>מסמכים נלווים</h2>
            <table id="documentsTable">
                <thead>
                    <tr>
                        <th> שם מסמך</th>
                        <th> תאריך הוספה</th>
                    </tr>
                </thead>
                <tbody id="documents-body">
                    <td><button onclick="deleteDocument()">מחק</button></td>

                </tbody>
            </table>
        </div>

        <div class="card hidden" id="document-display-area">
            <h2><i class="fas fa-file-alt"></i> Document Preview</h2>
            <iframe id="document-viewer" width="100%" height="500px"></iframe>
        </div>

        <div class="section" id="documentsTable">
            <h2>טבלת מסמכים נלווים</h2>
            <table>
                <tr>
                    <th>מסמך</th>
                    <th>פעולה</th>
                </tr>
                <tr>
                    <td>מסמך 1</td>
                    <td><button onclick="deleteDocument()">מחק</button></td>
                </tr>
            </table>
        </div>

        <div class="section" id="documentView">
            <h2>הצגת מסמך נלווה שנבחר</h2>
            <p>תצוגה של מסמך נלווה בפורמטים שונים.</p>
        </div> -->

        <div class="section" id="permissionsManagement">
            <h2>ניהול הרשאות</h2>
            <p>בדיקת הרשאות בכניסה לדף.</p>
        </div>

        <div class="section" id="reshumotNavigation">
            <h2>דפדוף ברשומות</h2>
            <p id="reshumotList">אפשרות לדפדוף ברשומות.</p>
            <form id="fieldsForm">
                <div class="field-container">
                    <label for="Rsh_Date">חתימת זמן אוטומטית:</label>
                    <input type="text" id="Rsh_Date" name="Rsh_Date">
                    <button type="button" onclick="clearField('Rsh_Date')">נקה</button>
                </div>  
                 <div class="field-container">
                    <label for="Rsh_mchlaka">מחלקה:</label>
                    <input type="text" id="Rsh_mchlaka" name="Rsh_mchlaka">
                    <button type="button" onclick="clearField('Rsh_mchlaka')">נקה</button>
                </div>  
                 <div class="field-container">
                    <label for="Rsh_sapak">שם הספק:</label>
                    <input type="text" id="Rsh_sapak" name="Rsh_sapak">
                    <button type="button" onclick="clearField('Rsh_sapak')">נקה</button>
                </div> 
                  <div class="field-container">
                    <label for="Rsh_proyktnam">תאריך נדרש:</label>
                    <input type="text" id="Rsh_proyktnam" name="Rsh_proyktnam">
                    <button type="button" onclick="clearField('Rsh_proyktnam')">נקה</button>
                </div> 
                <div class="field-container">
                    <label for="Rsh_sapak">ספק:</label>
                    <input type="text" id="Rsh_sapak" name="Rsh_sapak">
                    <button type="button" onclick="clearField('Rsh_sapak')">נקה</button>
                </div>
                <div class="field-container">
                    <label for="Rsh_schoom">סכום :</label>
                    <input type="text" id="Rsh_schoom" name="Rsh_schoom">
                    <button type="button" onclick="clearField('Rsh_schoom')">נקה</button>
                </div>

                <div class="field-container">
                    <label for="Rsh_maam"> מע"מ:</label>
                    <input type="text" id="Rsh_maam" name="Rsh_maam">
                    <button type="button" onclick="clearField('Rsh_maam')">נקה</button>
                </div>
                <div class="field-container">
                    <label for="Rsh_schmaam">סכום מע"מ:</label>
                    <input type="text" id="Rsh_schmaam" name="Rsh_schmaam">
                    <button type="button" onclick="clearField('Rsh_schmaam')">נקה</button>
                </div>

                <div class="field-container">
                    <label for="Rsh_schtotal">סך הכל:</label>
                    <input type="text" id="Rsh_schtotal" name="Rsh_schtotal">
                    <button type="button" onclick="clearField('Rsh_schtotal')">נקה</button>
                </div>

                <div class="field-container">
                    <label for="Rsh_sochen">סוכן:</label>
                    <input type="text" id="Rsh_sochen" name="Rsh_sochen">
                    <button type="button" onclick="clearField('Rsh_sochen')">נקה</button>
                </div>
                <div class="field-container">
                    <label for="Rsh_status">סטטוס:</label>
                    <input type="text" id="Rsh_status" name="Rsh_status">
                    <button type="button" onclick="clearField('Rsh_status')">נקה</button>
                </div>
                <div class="field-container">
                    <label for="Rsh_takziv">תזכיר:</label>
                    <input type="text" id="Rsh_takziv" name="Rsh_takziv">
                    <button type="button" onclick="clearField('Rsh_takziv')">נקה</button>
                </div>
            </form>
        </div>
        
        <div id="formContainer"></div> <!-- אלמנט מיכל עבור הטפסים -->
        
    <script>
        function calculateVAT() {
            const amount = document.getElementById('amount').value;
            const vat = amount * 0.17; // לדוגמה, מע"מ 17%
            document.getElementById('vat').value = vat;
            document.getElementById('totalAmount').value = parseFloat(amount) + vat;
        }

        function clearFields() {
            document.getElementById('documentForm').reset();
        }

        function clearField(fieldId) {
            document.getElementById(fieldId).value = '';
        }
/*************  ✨ Codeium Command ⭐  *************/
        /**
         * Saves the data from the form to the server.
         * @returns {void}
         */
/******  5dd1f630-969f-4cc7-9fdb-f97b0cdce5dc  *******/
        function saveData() {
            alert("נתונים נשמרו בהצלחה!");
        }

        function printData() {
            window.print();
        }

        function exit() {
            window.location.href = 'login.html'; // דף הלוגאין
        }

        function deleteDocument() {
            alert("המסמך נמחק.");
        }

        // פונקציה לניהול הרשאות
        setTimeout(() => {
            alert("אין פעילות בדף, תתבצע יציאה אוטומטית.");
            exit();
        }, 600000); // 10 דקות

        // פונקציה לטעינת רשומות
        async function getReshumot() {
        try {
            if (typeof listAllReshumot !== 'function') {
                console.error('Error: listAllReshumot function is not defined');
                const reshumotListDiv = document.getElementById('reshumotList');
                if (reshumotListDiv) {
                    reshumotListDiv.innerHTML = '<p>Error loading data: Function not available</p>';
                }
                return;
            }

            const reshumotListDiv = document.getElementById('reshumotList');
            if (!reshumotListDiv) {
                console.error('reshumotList element not found');
                return;
            }

            reshumotListDiv.innerHTML = '<p>Loading data...</p>';

            let reshumot;
            try {
                reshumot = await listAllReshumot();
                console.log('Received reshumot data:', reshumot);
                fillForm(reshumot);
            } catch (e) {
                console.error('Error calling listAllReshumot:', e);
                reshumotListDiv.innerHTML = '<p>Error fetching data: ' + e.message + '</p>';
                return;
            }

            if (!reshumot) {
                console.warn('Reshumot data is null or undefined');
                reshumotListDiv.innerHTML = '<p>No data available</p>';
                return;
            }

            if (Array.isArray(reshumot)) {
                if (reshumot.length === 0) {
                    reshumotListDiv.innerHTML = '<p>No records found</p>';
                } else {
                    reshumotListDiv.innerHTML = reshumot.map(item => `<p>${item || 'Unnamed record'}</p>`).join('');
                }
            } else {
                console.warn('Reshumot is not an array:', reshumot);
                reshumotListDiv.innerHTML = `<p>Data received in unexpected format</p>`;
                console.log('Data type:', typeof reshumot);
            }
        } catch (error) {
            console.error('Error in getReshumot function:', error);
            const reshumotListDiv = document.getElementById('reshumotList');
            if (reshumotListDiv) {
                reshumotListDiv.innerHTML = '<p>Error loading data: ' + error.message + '</p>';
            }
        }
    }
 
        window.onload = function () {
            initializeForm();
            getReshumot().catch(error => {
                console.error('Error in getReshumot:', error);
                const reshumotListDiv = document.getElementById('reshumotList');
                if (reshumotListDiv) {
                    reshumotListDiv.innerHTML = '<p>Failed to load data</p>';
                }
            });
        };

        function initializeForm() {
            const now = new Date();
            if (document.getElementById('timestamp')) {
                document.getElementById('timestamp').value = now.toLocaleString();
            }

            if (document.getElementById('autoNumber')) {
                document.getElementById('autoNumber').value = 'AUTO-' + Math.floor(Math.random() * 10000);
            }

            const formFields = document.querySelectorAll('#documentForm input, #documentForm select');
            formFields.forEach(field => {
                if (field.type === 'number' && !field.value) {
                    field.value = '0';
                }
            });

            calculateVAT();
        }


        function fillForm(data) {
        document.getElementById('Rsh_proyktnam').value = data.proyktnam || '';
        document.getElementById('Rsh_sapak').value = data.sapak || '';
        document.getElementById('Rsh_schmaam').value = data.schmaam || '';
        document.getElementById('Rsh_schoom').value = data.schoom || '';
        document.getElementById('Rsh_schtotal').value = data.schtotal || '';
        document.getElementById('Rsh_sochen').value = data.sochen || '';
        document.getElementById('Rsh_status').value = data.status || '';
        document.getElementById('Rsh_takziv').value = data.takziv || '';
    }
// -----------------------------------



            async function loadDocuments() {
                document.getElementById('documents-loading').classList.remove('hidden');
    document.getElementById('documentsTable').classList.add('hidden');
    document.getElementById('empty-documents').classList.add('hidden');
    
       
        const documents = await listAllMnilvim(); // קריאה לשרת
        document.getElementById('documents-loading').classList.add('hidden');
        
        const tbody = document.getElementById('documents-body');
        tbody.innerHTML = ''; // ניקוי התוכן הקודם

        documents.forEach(doc => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${doc.MN_pratim}</td>
                <td>${doc.MN_dateAdd}</td>
                <td><button onclick="deleteDocument('${doc.MN_id}')">מחק</button></td>
            `;
            row.onclick = () => showDocumentPreview(doc.MN_location, doc.MN_type); // תצוגה מקדימה
            tbody.appendChild(row);
        });
    }

  function showDocumentPreview(url, type) {
    const viewer = document.getElementById('document-viewer');
    const displayArea = document.getElementById('document-display-area');
    
    // נקה את התוכן הקודם
    viewer.src = "about:blank";
    displayArea.classList.remove('hidden');
    
    // בדוק את סוג הקובץ
    
    
    switch(type) {
        case 'pdf':
            // PDF יכול להיות מוצג ישירות
            viewer.src = url;
            
       
        case 'doc':
        case 'docx':
        case 'xls':
        case 'xlsx':
            // נסה להשתמש ב-Office Online Viewer (Microsoft)
            const officeViewerUrl = `https://view.officeapps.live.com/op/embed.aspx?src=${encodeURIComponent(url)}`;
            viewer.src = officeViewerUrl;
            break;
            
}
}

    // function showDocumentPreview(url) {
    //     const viewer = document.getElementById('document-viewer');
    //     viewer.src = url;
    //     document.getElementById('document-display-area').classList.remove('hidden');
    // }

    async function deleteDocument(id) {
        // כאן תוסיף את הקוד למחיקת המסמך מהשרת
        alert(`מסמך עם ID ${id} נמחק!`);
        loadDocuments(); // טען מחדש את המסמכים
    }

    // טען את המסמכים כאשר הדף נטען
    window.onload = loadDocuments;
            // ------------------------
            
        // function fillForm(data) {
        //     const container = document.getElementById('formContainer');
        //     container.innerHTML = ''; // נקה את התוכן הקודם

        //     if (Array.isArray(data) && data.length > 0) {
        //         data.forEach((item, index) => {
        //             const form = document.createElement('form');
        //             form.id = `form-${index + 1}`;
        //             form.innerHTML = `<h3>Form ${index + 1}</h3>`; // הוסף כותרת לכל טופס

        //             for (const key in item) {
        //                 if (item.hasOwnProperty(key)) {
        //                     const input = document.createElement('input');
        //                     input.type = 'text';
        //                     input.id = key + '-' + index; // הוסף מזהה ייחודי לכל שדה
        //                     input.value = item[key];
        //                     input.placeholder = key; // הוסף פלייסהולדר
        //                     form.appendChild(input);
        //                 }
        //             }
        //             container.appendChild(form); // הוסף את הטופס למיכל
        //         });
        //     } else {
        //         console.warn('Data is not an array or is empty:', data);
        //     }
        // }


        window.addEventListener('beforeunload', function () {
            updateUser(localStorage.getItem('userId'),
                {
                    Lg_timestmpiout: new Date().toLocaleString('sv-SE'),
                    Lg_status: 0
                }
            );
        });
        document.addEventListener('DOMContentLoaded', function () {
              // Try to load mnilvim
              if (typeof listAllMnilvim === 'function') {
                listAllMnilvim()
                    .then(documents => {
                        console.log('Documents loaded:', documents); // לוג של המסמכים שהוטענו
                        const tableBody = document.getElementById('documents-body');
                        tableBody.innerHTML = ''; // ניקוי התוכן הקיים

                        if (!documents || documents.length === 0) {
                            const row = tableBody.insertRow();
                            const cell = row.insertCell(0);
                            cell.colSpan = 7; // עדכון למספר השדות
                            cell.style.textAlign = 'center';
                            cell.textContent = 'No documents available';
                            return;
                        }

                        documents.forEach(doc => {
                            const row = tableBody.insertRow();

                            const idCell = row.insertCell(0);
                            idCell.textContent = doc.MN_id || 'N/A'; // הנחה שיש שדה בשם 'MN_id'

                            const pratimCell = row.insertCell(1);
                            pratimCell.textContent = doc.MN_pratim || 'N/A'; // הנחה שיש שדה בשם 'MN_pratim'

                            const locationCell = row.insertCell(2);
                            locationCell.textContent = doc.MN_location || 'N/A'; // הנחה שיש שדה בשם 'MN_location'

                            const MN_shyoochCell = row.insertCell(3);
                            idCell.textContent = doc.MN_shyooch || 'N/A'; // הנחה שיש שדה בשם 'MN_id'

                            const MN_statusCell = row.insertCell(4);
                            pratimCell.textContent = doc.MN_status || 'N/A'; // הנחה שיש שדה בשם 'MN_pratim'

                            const MN_dateAddCell = row.insertCell(5);
                            locationCell.textContent = doc.MN_dateAdd || 'N/A'; // הנחה שיש שדה בשם 'MN_location'
                           
                            const MN_typeCell = row.insertCell(6);
                            locationCell.textContent = doc.MN_type || 'N/A'; // הנחה שיש שדה בשם 'MN_location'

                            // הוספת כפתורים לפעולות (אם יש צורך)
                            const actionsCell = row.insertCell(6);
                            const viewBtn = document.createElement('button');
                            viewBtn.className = 'action-btn';
                            viewBtn.innerHTML = '<i class="fas fa-eye"></i>';
                            viewBtn.title = 'View Document';
                            viewBtn.onclick = function () {
                                // הוסף כאן את הלוגיקה להצגת המסמך אם יש צורך
                            };
                            actionsCell.appendChild(viewBtn);

                            const deleteBtn = document.createElement('button');
                            deleteBtn.className = 'action-btn';
                            deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
                            deleteBtn.title = 'Delete Document';
                            deleteBtn.onclick = function () {
                                Swal.fire({
                                    title: 'Are you sure?',
                                    text: "You won't be able to revert this!",
                                    icon: 'warning',
                                    showCancelButton: true,
                                    confirmButtonColor: '#d33',
                                    cancelButtonColor: '#3085d6',
                                    confirmButtonText: 'Yes, delete it!'
                                }).then((result) => {
                                    if (result.isConfirmed) {
                                        // הוסף כאן קוד למחיקת המסמך מהשרת
                                        Swal.fire('Deleted!', 'Your document has been deleted.', 'success');
                                        loadDocuments(); // טען מחדש את המסמכים
                                    }
                                });
                            };
                            actionsCell.appendChild(deleteBtn);
                        });
                    })
                    .catch(error => {
                        console.error('Error loading documents:', error);
                        showNotification('Failed to load documents', 'error');
                    });
            } else {
                console.error('listAllMnilvim function is not available');
            }
            checkPR();
            if (document.referrer.includes("login")) {
                updateUser(localStorage.getItem('userId'), {
                    Lg_timestmpin: new Date().toLocaleString('sv-SE'),
                    Lg_status: 1
                });
            }
        });

        function checkPR() {

            if (localStorage.getItem('PR') === '2') {
                document.getElementById('conditionalButton').style.display = 'block';
            } else {
                document.getElementById('conditionalButton').style.display = 'none';
            }
        }

        function goToAdmin() {
            window.location.href = 'admin.html';
        }



    </script>
</body>

</html>
