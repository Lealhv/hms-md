<!DOCTYPE html>
<html lang="he">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>מערכת ניהול מסמכים</title>
    <link rel="stylesheet" href="worker.style.css">

    <style>
        body {
            font-family: Arial, sans-serif;
        }

        /* .container {
            width: 80%;
            margin: auto;
        } */

        .section {
            margin: 20px 0;
            padding: 10px;
            border: 1px solid #ccc;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-left: 4px solid #007bff;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            max-width: 300px;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            z-index: 1000;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            border-left-color: #28a745;
        }

        .notification.error {
            border-left-color: #dc3545;
        }

        .notification-icon {
            margin-right: 10px;
            font-size: 1.2em;
        }

        .notification-message {
            flex-grow: 1;
        }

        .notification-close {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1em;
        }

        /* Header styling */
        #header {
            background: linear-gradient(135deg, #2c3e50, #3498db);
            color: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            margin-bottom: 25px;
            border: none;
            padding: 0;
            overflow: hidden;
            text-align: center;
        }

        .header-container {
            padding: 40px 30px;
            position: relative;
        }

        .title-area {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .title-area h1 {
            margin: 0;
            font-size: 6rem;
            /* Even larger h1 */
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            letter-spacing: 1px;
        }

        .subtitle {
            margin: 10px 0 0;
            font-size: 1rem;
            /* Smaller subtitle */
            opacity: 0.8;
            font-weight: 300;
        }

        /* Add a decorative element */
        .header-container:after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(to right, #3498db, #2ecc71, #f1c40f, #e74c3c);
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .header-container {
                padding: 25px;
            }

            .title-area h1 {
                font-size: 6rem;
            }

            .subtitle {
                font-size: 1.5rem;
            }
        }
    </style>
    <script src="services/reshumot.server.js" defer></script>
    <script src="services/mnilvim.server.js" defer></script>
    <script src="services/userLog.server.js" defer></script>
    <script src="services/Suppliers.server.js" defer></script>

    <!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"> -->


    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</head>

<body onload="getData()">
    <div class="container">
        <div class="section" id="header">
            <div class="header-container">
                <div class="logo-area">
                </div>
                <div class="title-area">
                    <h1>מערכת ניהול הזמנות</h1>
                    <p class="subtitle">המערכת המתקדמת לניהול ומעקב אחר הזמנות</p>
                </div>
            </div>
        </div>


        <div class="header-buttons">
            <button type="button" class="btn-danger" onclick="exit()">
                <i class="fas fa-sign-out-alt"></i> יציאה
            </button>
            <button id="conditionalButton" class="admin-btn" onclick="goToAdmin()">לעמוד מנהל</button>
        </div>


        <div class="section" id="input-form">

            <h2>טופס הזמנה</h2>
            <form id="documentForm">
                <!-- Row 1 -->
                <div class="form-group">
                    <label for="department">מחלקה:</label>
                    <input type="text" id="department" name="department" placeholder="הזן שם מחלקה">
                    <div id="error-department" class="error-message" style="color: red;"></div>
                </div>

                <div class="form-group">
                    <label for="supplierName">שם הספק:</label>
                    <select id="supplierName" name="supplierName">
                        <option value="" disabled selected>בחר ספק</option>
                    </select>
                    <div id="error-supplierName" class="error-message" style="color: red;"></div>
                </div>
                <div class="form-group checkbox-container">
                    <label for="exempt">עוסק פטור:</label>
                    <input type="checkbox" id="exempt" name="exempt">
                    <div id="error-exempt" class="error-message" style="color: red;"></div>
                </div>

                <div class="form-group">
                    <label for="amount">סכום:</label>
                    <input type="number" id="amount" name="amount" onchange="calculateVAT()" placeholder="הזן סכום">
                    <div id="error-amount" class="error-message" style="color: red;"></div>
                </div>
                <!-- 
                <div class="form-group">
                    <label for="maam_id">מע"מ:</label>
                    <input type="number" id="maam_id" name="vat" readonly>
                    <div id="error-maam_id" class="error-message" style="color: red;"></div>
                </div>

                <div class="form-group">
                    <label for="scmaan">סכום מע"מ:</label>
                    <input type="number" id="scmaan" name="scmaan" readonly>
                    <div id="error-scmaan" class="error-message" style="color: red;"></div>
                </div>

                <div class="form-group">
                    <label for="totalAmount">סכום כולל:</label>
                    <input type="number" id="totalAmount" name="totalAmount" readonly>
                    <div id="error-totalAmount" class="error-message" style="color: red;"></div>
                </div> -->

                <div class="form-group">
                    <label for="deliveryPlace">מקום אספקה:</label>
                    <input type="text" id="deliveryPlace" name="deliveryPlace" placeholder="הזן מקום אספקה">
                    <div id="error-deliveryPlace" class="error-message" style="color: red;"></div>
                </div>

                <div class="form-group">
                    <label for="agentNumber">מס סוכן:</label>
                    <input type="text" id="agentNumber" name="" placeholder="הזן מספר סוכן">
                    <div id="error-agentNumber" class="error-message" style="color: red;"></div>
                </div>

                <div class="form-group">
                    <label for="contactName">שם סוכן:</label>
                    <input type="text" id="contactName" name="contactName" placeholder="הזן שם סוכן">
                    <div id="error-contactName" class="error-message" style="color: red;"></div>
                </div>

                <div class="form-group">
                    <label for="contactPhone">טלפון סוכן:</label>
                    <input type="text" id="contactPhone" name="contactPhone" placeholder="הזן טלפון סוכן">
                    <div id="error-contactPhone" class="error-message" style="color: red;"></div>
                </div>

                <div class="form-group">
                    <label for="contactEmail">מייל סוכן:</label>
                    <input type="email" id="contactEmail" name="contactEmail" placeholder="הזן מייל סוכן">
                    <div id="error-contactEmail" class="error-message" style="color: red;"></div>
                </div>

                <div class="form-group">
                    <label for="projectName">שם פרויקט:</label>
                    <input type="text" id="projectName" name="projectName" placeholder="הזן שם פרויקט">
                    <div id="error-projectName" class="error-message" style="color: red;"></div>
                </div>

                <div class="form-group">
                    <label for="budgetItem">מספר סעיף תקציבי:</label>
                    <input type="number" id="budgetItem" name="budgetItem" placeholder="הזן מספר סעיף">
                    <div id="error-budgetItem" class="error-message" style="color: red;"></div>
                </div>

                <!-- Hidden fields -->
                <input type="hidden" id="autoNumber" name="autoNumber">
                <input type="hidden" id="timestamp" name="timestamp">

                <div id="error-message" class="error-message" style="color: red;"></div>


                <!-- Buttons -->
                <div class="btn-container">
                    <!-- Replace the entire buttons section with this: -->
                    <div class="btn-container">
                        <button type="button" class="btn-primary form-action-btn" onclick="saveData()">
                            <i class="fas fa-save"></i> שמירת נתונים
                        </button>

                        <button type="button" class="btn-secondary form-action-btn"
                            onclick="document.getElementById('document').click();">
                            <i class="fas fa-file-upload"></i> הוספת מסמכים נילווים
                        </button>
                        <button type="button" class="btn-secondary form-action-btn" onclick="printData()">
                            <i class="fas fa-print"></i> הדפסה
                        </button>
                        <button type="button" class="btn-secondary form-action-btn" onclick="exportToPDF()">
                            <i class="fas fa-file-pdf"></i> ייצוא PDF
                        </button>
                        <button type="button" class="btn-secondary form-action-btn" onclick="exportToExcel()">
                            <i class="fas fa-file-excel"></i> ייצוא EXCEL
                        </button>
                        <button type="button" class="btn-secondary" onclick="clearFields()">
                            <i class="fas fa-eraser"></i> ניקוי
                        </button>
                    </div>

                </div>
            </form>
        </div>

        <!-- ---------------------------------------------------- -->


        <div class="card" id="documents-area">
            <h2><i class="fas fa-folder-open"></i> מסמכים נלווים</h2>
            <div id="message" style="display:none; color:red;"></div> <!-- הודעה נפרדת -->
            <table id="documentsTable" style="display:none;">
                <thead>
                    <tr>
                        <th>שם מסמך</th>
                        <th>תאריך הוספה</th>
                        <th>פעולה</th>
                    </tr>
                </thead>
                <tbody id="documents-body">
                </tbody>
            </table>
        </div>

        <div id="reshumotList">
        </div>

        <div id="formContainer"></div> <!-- הוספת אלמנט זה -->


        <!-- להעביר למנהל -->
        <!-- <input type="file" id="file-input" style="display: none;" onchange="handleFileUpload(event)"> -->



        <input type="file" id="document" style="display: none;" onchange="MnilvimUpload(event)">

    </div>

    <script>
        let isFunctionCalled = false; // משתנה גלובלי לבדוק אם הפונקציה זומנה

        var RSH_ID = 0;
        function getData() {
            getReshumot();
            checkFunctionCall();
            loadSuppliers();

            //  loadDocuments();

        }
        async function loadSuppliers() {
            const suppliers = await getAllSuppliers(); // הנחה שהפונקציה מחזירה את הספקים
            console.log(suppliers); // הוסף לוג כאן כדי לבדוק מה מוחזר
            const supplierSelect = document.getElementById('supplierName');
            supplierSelect.innerHTML = '<option value="" disabled selected>בחר ספק</option>'; // ניקוי אפשרויות קודמות

            suppliers.forEach(supplier => {
                const option = document.createElement('option');
                option.value = supplier.SP_name; // הנח כאן את השם של הספק
                option.textContent = supplier.SP_name; // הנח כאן את השם של הספק
                supplierSelect.appendChild(option);
            });
        }
        // function calculateVAT() {
        //     const amount = document.getElementById('amount').value;
        //     let maam = document.getElementById('maam_id').value;
        //     maam = maam / 100;
        //     const vat = amount * maam; // לדוגמה, מע"מ 17%
        //     document.getElementById('scmaan').value = vat;
        //     document.getElementById('totalAmount').value = parseFloat(amount) + vat;
        // }
        // Function to check if all required fields are filled
        function checkFormCompletion() {
            const requiredFields = [
                'department',
                'supplierName',
                'amount',
                'deliveryPlace',
                'agentNumber',
                'contactName',
                'contactPhone',
                'contactEmail',
                'projectName',
                'budgetItem'
            ];

            let allFilled = true;

            for (const fieldId of requiredFields) {
                const field = document.getElementById(fieldId);
                if (!field || !field.value.trim()) {
                    allFilled = false;
                    break;
                }
            }

            // Special validation for phone and email
            const phone = document.getElementById('contactPhone').value;
            const email = document.getElementById('contactEmail').value;

            if (!validatePhone(phone) || !validateEmail(email)) {
                allFilled = false;
            }

            // Update buttons state
            const actionButtons = document.querySelectorAll('.form-action-btn');
            actionButtons.forEach(button => {
                if (allFilled) {
                    button.classList.remove('disabled-btn');
                    button.disabled = false;
                } else {
                    button.classList.add('disabled-btn');
                    button.disabled = true;
                }
            });
        }

        // Add event listeners to all form fields to check completion on input
        document.addEventListener('DOMContentLoaded', function () {
            const formFields = document.querySelectorAll('#documentForm input, #documentForm select');
            formFields.forEach(field => {
                field.addEventListener('input', checkFormCompletion);
            });

            // Initial check
            checkFormCompletion();
        });


        function validateForm() {
            const department = document.getElementById("department").value;
            const supplierName = document.getElementById("supplierName").value;
            const amount = document.getElementById("amount").value;
            const deliveryPlace = document.getElementById("deliveryPlace").value;
            const agentNumber = document.getElementById("agentNumber").value;
            const contactName = document.getElementById("contactName").value;
            const contactPhone = document.getElementById("contactPhone").value;
            const contactEmail = document.getElementById("contactEmail").value;
            const projectName = document.getElementById("projectName").value;
            const budgetItem = document.getElementById("budgetItem").value;

            // נקה הודעות שגיאה קודמות
            clearErrorMessages();

            let isValid = true;

            if (!department) {
                document.getElementById("error-department").innerText = "מחלקה היא שדה חובה.";
                isValid = false;
            }

            if (!supplierName) {
                document.getElementById("error-supplierName").innerText = "יש לבחור ספק.";
                isValid = false;
            }

            if (!amount || amount <= 0) {
                document.getElementById("error-amount").innerText = "סכום חייב להיות חיובי.";
                isValid = false;
            }

            if (!deliveryPlace) {
                document.getElementById("error-deliveryPlace").innerText = "מקום אספקה הוא שדה חובה.";
                isValid = false;
            }

            if (!agentNumber) {
                document.getElementById("error-agentNumber").innerText = "מס סוכן הוא שדה חובה.";
                isValid = false;
            }

            if (!contactName) {
                document.getElementById("error-contactName").innerText = "שם סוכן הוא שדה חובה.";
                isValid = false;
            }

            if (!validatePhone(contactPhone)) {
                document.getElementById("error-contactPhone").innerText = "טלפון סוכן לא תקין.";
                isValid = false;
            }

            if (!validateEmail(contactEmail)) {
                document.getElementById("error-contactEmail").innerText = "מייל סוכן לא תקין.";
                isValid = false;
            }

            if (!projectName) {
                document.getElementById("error-projectName").innerText = "שם פרויקט הוא שדה חובה.";
                isValid = false;
            }

            if (budgetItem === "" || budgetItem < 0 || budgetItem == 0) {
                document.getElementById("error-budgetItem").innerText = "תקציב חייב להיות מספר חיובי.";
                isValid = false;
            }

            return isValid; // מחזיר true אם כל הבדיקות עברו
        }

        function validateEmail(email) {
            const regex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return regex.test(email);
        }

        function validatePhone(phone) {
            const regex = /^\d{10}$/; // בדיקה לפורמט טלפון של 10 ספרות
            return regex.test(phone);
        }

        function clearErrorMessages() {
            const errorIds = [
                "error-department",
                "error-supplierName",
                "error-amount",
                "error-deliveryPlace",
                "error-agentNumber",
                "error-contactName",
                "error-contactPhone",
                "error-contactEmail",
                "error-projectName",
                "error-budgetItem"
            ];

            errorIds.forEach(id => {
                document.getElementById(id).innerText = "";
            });
        }

        // הוסף מאזיני אירועים לכל שדה
        document.querySelectorAll('input, select').forEach(element => {
            setupErrorClearingListeners();
            element.addEventListener('input', clearErrorMessages);
        });



        function setupErrorClearingListeners() {
            document.querySelectorAll('input, select').forEach(element => {
                element.addEventListener('input', clearErrorMessages);
            });
        }

        function clearErrorMessages() {
            const errorIds = [
                "error-department",
                "error-supplierName",
                "error-amount",
                "error-deliveryPlace",
                "error-agentNumber",
                "error-contactName",
                "error-contactPhone",
                "error-contactEmail",
                "error-projectName",
                "error-budgetItem"
            ];

            errorIds.forEach(id => {
                document.getElementById(id).innerText = "";
            });
        }

        // הוסף מאזיני אירועים לכל שדה
        document.querySelectorAll('input, select').forEach(element => {
            element.addEventListener('input', clearErrorMessages);
        });



        // פונקציה לבדוק אם המייל תקין
        function validateEmail(email) {
            const regex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return regex.test(email);
        }

        // עדכון הפונקציה לשמירת נתונים

        function clearFields() {
            // Check if elements exist before trying to set their value
            if (document.getElementById('autoNumber')) document.getElementById('autoNumber').value = '';
            if (document.getElementById('timestamp')) document.getElementById('timestamp').value = '';
            if (document.getElementById('department')) document.getElementById('department').value = '';
            if (document.getElementById('supplierName')) document.getElementById('supplierName').value = 'ספק 1';
            // Remove or replace this line since requiredDate doesn't exist
            // if (document.getElementById('requiredDate')) document.getElementById('requiredDate').value = '';
            if (document.getElementById('amount')) document.getElementById('amount').value = '';
            // Change 'vat' to 'maam_id' since that's what's in your HTML
            // if (document.getElementById('maam_id')) document.getElementById('maam_id').value = '';
            if (document.getElementById('scmaan')) document.getElementById('scmaan').value = '';
            if (document.getElementById('totalAmount')) document.getElementById('totalAmount').value = '';
            if (document.getElementById('deliveryPlace')) document.getElementById('deliveryPlace').value = '';
            if (document.getElementById('contactName')) document.getElementById('contactName').value = '';
            if (document.getElementById('contactPhone')) document.getElementById('contactPhone').value = '';
            if (document.getElementById('contactEmail')) document.getElementById('contactEmail').value = '';
            if (document.getElementById('projectName')) document.getElementById('projectName').value = '';
            if (document.getElementById('agentNumber')) document.getElementById('agentNumber').value = '';
            if (document.getElementById('budgetItem')) document.getElementById('budgetItem').value = '';

            // If you have a checkbox for exempt, you might want to uncheck it
            if (document.getElementById('exempt')) document.getElementById('exempt').checked = false;
            checkFormCompletion();
            loadDocuments();
        }


        function clearField(fieldId) {
            document.getElementById(fieldId).value = '';
        }

        function printData() {
            window.print();
        }

        function exit() {
            window.location.href = 'login.html'; // דף הלוגאין
        }


        function MnilvimUpload(event) {
            event.preventDefault(); // למנוע את שליחת הטופס הרגילה

            const fileInput = document.getElementById('document');
            const data = {};

            // הוסף את המידע הנוסף
            if (fileInput.files.length > 0) {
                const file = fileInput.files[0];
                const lastDotIndex = file.name.lastIndexOf('.');
                const fileNameWithoutExtension = lastDotIndex !== -1 ? file.name.substring(0, lastDotIndex) : file.name;
                data.MN_pratim = fileNameWithoutExtension;
                data.MN_location = fileInput.value; // מיקום הקובץ במחשב
                data.MN_shyooch = RSH_ID; // לדוגמה, RSH_ID
                data.MN_status = 1; // סטטוס
                data.MN_dateAdd = new Date().toISOString().split('T')[0]; // תאריך של היום
                data.MN_type = file.type; // סוג הקובץ
            }
            addMnilvim(data)
                .then(response => {
                    if (response.message === "Mnilvim added successfully")
                        // הנח את ההודעה כאן אם ההוספה הצליחה
                        showNotification("הקובץ נוסף בהצלחה!");
                    loadDocuments(RSH_ID);
                })
                .catch(error => {

                    // הנח את ההודעה כאן אם הייתה שגיאה
                    showNotification("אירעה שגיאה בהוספת הקובץ: " + error.message);
                });
        }


        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    const content = e.target.result;
                    const rows = content.split('\n').map(row => row.split(','));
                    const headers = rows[0].map(header => header.trim());
                    const data = rows[1].map(value => value.trim());
                    const expectedFields = [
                        "Record Number", "Timestamp", "Department", "Supplier Name", "Amount",
                        "VAT", "Total Amount", "Delivery Location", "Contact Name",
                        "Contact Phone", "Contact Email", "Project Name", "Agent Number", "Budget Item"
                    ];
                    if (headers.length !== expectedFields.length) {
                        showNotification("הקובץ שהועלה אינו תואם לשדות הדרושים");
                        return;
                    }

                    for (let i = 0; i < headers.length; i++) {
                        const fieldId = headers[i].toLowerCase().replace(/ /g, '-');
                        if (document.getElementById(fieldId)) {
                            document.getElementById(fieldId).value = data[i];
                        }
                    }
                    showNotification("הקובץ הועלה ויובאו נתונים בהצלחה!");
                };
                reader.readAsText(file);
            }
            event.target.value = '';
        }

        function showNotification(message, type = 'info') {
            const existingNotifications = document.querySelectorAll('.notification');
            existingNotifications.forEach(notification => {
                notification.remove();
            });

            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            let icon = 'info-circle';
            if (type === 'success') {
                icon = 'check-circle';
            } else if (type === 'error') {
                icon = 'exclamation-circle';
            }
            notification.innerHTML = `
                <div class="notification-icon">
                    <i class="fas fa-${icon}"></i>
                </div>
                <div class="notification-message">${message}</div>
                <button class="notification-close" onclick="this.parentElement.remove()">
                    <i class="fas fa-times"></i>
                </button>
            `;
            document.body.appendChild(notification);
            setTimeout(() => {
                notification.classList.add('show');
            }, 10);
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.classList.remove('show');
                    setTimeout(() => {
                        if (notification.parentElement) {
                            notification.remove();
                        }
                    }, 300);
                }
            }, 5000);
        }



        function exportToPDF() {
            const element = document.querySelector('.container');
            html2pdf()
                .from(element)
                .save('purchase_request.pdf')
                .then(() => {
                    showNotification('הקובץ PDF יוצא בהצלחה!');
                });
        }
        function exportToExcel() {
            const data = [
                ['Record Number', 'Timestamp', 'Department', 'Supplier Name', 'Patoor', 'Amount', 'Delivery Location', 'sochen', 'Contact Name', 'Contact Phone', 'Contact Email', 'Project Name', 'Budget Item'],
                [
                    document.getElementById('autoNumber').value,
                    document.getElementById('timestamp').value,
                    document.getElementById('department').value,
                    document.getElementById('supplierName').value,
                    document.getElementById('exempt') ? (document.getElementById('exempt').checked ? "1" : "0") : "0",
                    document.getElementById('amount').value,
                    document.getElementById('deliveryPlace').value,
                    document.getElementById('agentNumber').value,
                    document.getElementById('contactName').value,
                    document.getElementById('contactPhone').value,
                    document.getElementById('contactEmail').value,
                    document.getElementById('projectName').value,
                    document.getElementById('budgetItem').value
                ]
            ];

            console.log(data);

            const workbook = XLSX.utils.book_new();

            // המרת המערך לאובייקט מתאים ל-XLSX
            const worksheetData = [data[0]].concat(data.slice(1));
            const worksheet = XLSX.utils.aoa_to_sheet(worksheetData);

            // הוסף את הגיליון לחוברת העבודה
            XLSX.utils.book_append_sheet(workbook, worksheet, "Data");

            // שמור את הקובץ
            XLSX.writeFile(workbook, "data.xlsx");
        }

        async function saveData() {

            if (validateForm()) {
                const recordId = document.getElementById('autoNumber').value;

                try {
                    // Fetch all records to check if the record already exists
                    const records = await listAllReshumot();
                    const existingRecord = records.find(record => record.Rsh_id === recordId);

                    const data = {
                        Rsh_id: recordId,
                        Rsh_date: new Date().toLocaleString('sv-SE'),
                        Rsh_mchlaka: document.getElementById('department').value,
                        Rsh_sapak: document.getElementById('supplierName').value,
                        Rsh_patoor: document.getElementById('exempt').checked ? '1' : '0',
                        Rsh_schoom: document.getElementById('amount').value,
                        Rsh_aspaka: document.getElementById('deliveryPlace').value,
                        Rsh_proyktnam: document.getElementById('projectName').value,
                        Rsh_sochen: document.getElementById('agentNumber').value,
                        Rsh_takziv: document.getElementById('budgetItem').value,
                        Rsh_cname: document.getElementById('contactName').value,
                        Rsh_cnametl: document.getElementById('contactPhone').value || '',
                        Rsh_cemail: document.getElementById('contactEmail').value
                    };

                    console.log("Data object:", data);
debugger
                    let response;
                    if (existingRecord) {
                        // If record exists, update it
                        response = await updateReshumot(data, recordId);
                        if (response && response.message === "Reshumot updated successfully") {
                            showNotification('הזמנה עודכנה בהצלחה!');
                            getReshumot();
                        } else {
                            showNotification('שגיאה בעדכון ההזמנה', 'error');
                        }
                    } else {
                        // If record does not exist, create it
                        response = await createReshumot(data);
                        if (response && response.message === "Reshumot created successfully") {
                            showNotification('הזמנה נשמרה בהצלחה!');
                            getReshumot();
                        } else {
                            showNotification('שגיאה בשמירת ההזמנה', 'error');
                        }
                    }

                    clearFields(); // Clear fields after saving
                } catch (error) {
                    console.error('Error saving Reshuma:', error);
                    console.error('Error details:', error.message);

                    // Show a more user-friendly error message
                    showNotification('שגיאה בשמירת ההזמנה: ' +
                        (error.message.includes("invalid response") ?
                            "בעיה בתקשורת עם השרת" : error.message), 'error');
                }
            }
        }



        // פונקציה לניהול הרשאות
        setTimeout(() => {
            alert("אין פעילות בדף, תתבצע יציאה אוטומטית.");
            exit();
        }, 600000); // 10 דקות

        // פונקציה לטעינת הזמנות
        async function getReshumot() {
            try {
                let reshumot;
                try {
                    reshumot = await listAllReshumot();
                    fillForm(reshumot);
                } catch (e) {
                    console.error('Error calling listAllReshumot:', e);
                    reshumotListDiv.innerHTML = '<p>Error fetching data: ' + e.message + '</p>';
                    return;
                }

                if (!reshumot) {
                    console.warn('Reshumot data is null or undefined');
                    reshumotListDiv.innerHTML = '<p>No data available</p>';
                    return;
                }

            } catch (error) {
                console.error('Error in getReshumot function:', error);
                const reshumotListDiv = document.getElementById('reshumotList');
                if (reshumotListDiv) {
                    reshumotListDiv.innerHTML = '<p>Error loading data: ' + error.message + '</p>';
                }
            }
        }

        window.onload = function () {
            initializeForm();
            try {
                getData();
            } catch (error) {
                console.error('Error in getData:', error);
                const reshumotListDiv = document.getElementById('reshumotList');
                if (reshumotListDiv) {
                    reshumotListDiv.innerHTML = '<p>Failed to load data</p>';
                }
            }
        };

        function initializeForm() {
            const now = new Date();
            if (document.getElementById('timestamp')) {
                document.getElementById('timestamp').value = now.toLocaleString();
            }

            if (document.getElementById('autoNumber')) {
                document.getElementById('autoNumber').value = 'AUTO-' + Math.floor(Math.random() * 10000);
            }

            const formFields = document.querySelectorAll('#documentForm input, #documentForm select');
            formFields.forEach(field => {
                if (field.type === 'number' && !field.value) {
                    field.value = '0';
                }
            });
        }
        function fillForm(data) {
            debugger
            const formContainer = document.getElementById('formContainer');
            formContainer.innerHTML = ''; // Clear previous content

            const titleMapping = {
                'Rsh_date': 'תאריך',
                'Rsh_mchlaka': 'מחלקה',
                'Rsh_sapak': 'ספק',
                'Rsh_patoor': 'פטור',
                'Rsh_schoom': 'סכום',
                'Rsh_aspaka': 'מקום אספקה', // שדה זה הוחלף
                'Rsh_proyktnam': 'שם פרויקט', // שדה זה הוחלף
                'Rsh_sochen': 'סוכן',
                'Rsh_takziv': 'מספר סעיף תקציבי',
                'Rsh_cname': 'שם סוכן',
                'Rsh_cnametl': 'טלפון סוכן',
                'Rsh_cemail': 'מייל סוכן'
            };

            const tableContainer = document.createElement('div');
            tableContainer.style.backgroundColor = '#fff';
            tableContainer.style.borderRadius = '8px';
            tableContainer.style.boxShadow = '0 4px 15px rgba(0, 0, 0, 0.1)';
            tableContainer.style.overflow = 'hidden';
            tableContainer.style.marginBottom = '30px';
            tableContainer.style.fontSize = '0.85rem';

            const tableHeader = document.createElement('div');
            tableHeader.style.padding = '15px 20px';
            tableHeader.style.backgroundColor = '#3498db';
            tableHeader.style.color = 'white';
            tableHeader.style.borderBottom = '1px solid #e0e0e0';
            tableHeader.innerHTML = '<h3 style="margin: 0; font-size: 1.2rem;"><i class="fas fa-list-alt" style="margin-right: 10px;"></i>רשימת הזמנות</h3>';
            tableContainer.appendChild(tableHeader);

            const table = document.createElement('table');
            table.className = 'records-table';
            table.style.width = '100%';
            table.style.borderCollapse = 'collapse';
            table.style.fontSize = '0.8rem';

            const headerRow = document.createElement('tr');

            for (const title in titleMapping) {
                const th = document.createElement('th');
                th.textContent = titleMapping[title];
                th.style.padding = '10px 8px';
                th.style.textAlign = 'center';
                th.style.backgroundColor = '#f8f9fa';
                th.style.color = '#495057';
                th.style.fontWeight = '600';
                th.style.borderBottom = '2px solid #dee2e6';
                th.style.fontSize = '0.8rem';
                headerRow.appendChild(th);
            }

            const thead = document.createElement('thead');
            thead.appendChild(headerRow);
            table.appendChild(thead);

            const tbody = document.createElement('tbody');

            let activeRow = null;

            data.forEach((item, index) => {
                const row = document.createElement('tr');
                row.style.position = 'relative';
                row.style.cursor = 'pointer';

                row.style.backgroundColor = index % 2 === 0 ? '#ffffff' : '#f8f9fa';

                for (const key in titleMapping) {
                    const td = document.createElement('td');
                    td.textContent = item[key] || 'לא צוין';
                    td.style.padding = '8px 10px';
                    td.style.textAlign = 'center';
                    td.style.borderBottom = '1px solid #e9ecef';
                    td.style.fontSize = '0.75rem';
                    row.appendChild(td);
                }

                const overlay = document.createElement('div');
                overlay.className = 'row-action-overlay';
                overlay.style.position = 'absolute';
                overlay.style.top = '0';
                overlay.style.left = '0';
                overlay.style.width = '100%';
                overlay.style.height = '100%';
                overlay.style.backgroundColor = 'rgba(52, 152, 219, 0.3)';
                overlay.style.display = 'none';
                overlay.style.justifyContent = 'center';
                overlay.style.alignItems = 'center';
                overlay.style.zIndex = '10';
                overlay.style.transition = 'all 0.3s ease';

                const buttonContainer = document.createElement('div');
                buttonContainer.style.display = 'flex';
                buttonContainer.style.gap = '15px';

                const editButton = document.createElement('button');
                editButton.innerHTML = '<i class="fas fa-edit"></i> עריכה';
                editButton.style.padding = '8px 15px';
                editButton.style.borderRadius = '4px';
                editButton.style.border = 'none';
                editButton.style.backgroundColor = 'white';
                editButton.style.color = '#3498db';
                editButton.style.cursor = 'pointer';
                editButton.style.fontWeight = 'bold';
                editButton.style.boxShadow = '0 2px 5px rgba(0,0,0,0.2)';

                editButton.onclick = function (e) {
                    e.stopPropagation();
                    loadRecordToForm(item);
                    loadDocuments(item.Rsh_id);
                    overlay.style.display = 'none';
                    activeRow = null;
                    window.scrollTo({
                        top: 0,
                        behavior: 'smooth' // הוספת אפקט גלילה חלקה
                    });
                };

                const deleteButton = document.createElement('button');
                deleteButton.innerHTML = '<i class="fas fa-trash-alt"></i> מחיקה';
                deleteButton.style.padding = '8px 15px';
                deleteButton.style.borderRadius = '4px';
                deleteButton.style.border = 'none';
                deleteButton.style.backgroundColor = 'white';
                deleteButton.style.color = '#e74c3c';
                deleteButton.style.cursor = 'pointer';
                deleteButton.style.fontWeight = 'bold';
                deleteButton.style.boxShadow = '0 2px 5px rgba(0,0,0,0.2)';

                deleteButton.onclick = async function (e) {
                    e.stopPropagation();

                    const result = await Swal.fire({
                        title: 'אישור מחיקה',
                        text: 'האם אתה בטוח שברצונך למחוק הזמנה זו?',
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonColor: '#d33',
                        cancelButtonColor: '#3085d6',
                        confirmButtonText: 'כן, מחק את זה!',
                        cancelButtonText: 'לא, ביטול'
                    });

                    if (result.isConfirmed) {
                        const res = await deleteReshumot(item.Rsh_id);
                        if (res.message === "Reshumot deleted successfully") {
                            row.remove();
                            showNotification('ההזמנה נמחקה בהצלחה');
                        } else {
                            showNotification('שגיאה במחיקת ההזמנה');
                        }
                    }

                    overlay.style.display = 'none';
                    activeRow = null;
                };

                buttonContainer.appendChild(editButton);
                buttonContainer.appendChild(deleteButton);
                overlay.appendChild(buttonContainer);
                row.appendChild(overlay);

                row.onclick = function () {
                    if (this === activeRow) {
                        overlay.style.display = 'none';
                        activeRow = null;
                        return;
                    }

                    if (activeRow) {
                        const activeOverlay = activeRow.querySelector('.row-action-overlay');
                        if (activeOverlay) {
                            activeOverlay.style.display = 'none';
                        }
                    }

                    overlay.style.display = 'flex';
                    activeRow = this;

                    this.style.backgroundColor = '#e9f7fe';
                };

                tbody.appendChild(row);
            });

            table.appendChild(tbody);
            tableContainer.appendChild(table);
            formContainer.appendChild(tableContainer);

            if (data.length === 0) {
                const noDataMsg = document.createElement('div');
                noDataMsg.style.textAlign = 'center';
                noDataMsg.style.padding = '30px 20px';
                noDataMsg.style.color = '#7f8c8d';
                noDataMsg.style.backgroundColor = '#f9f9f9';
                noDataMsg.style.borderRadius = '8px';
                noDataMsg.style.boxShadow = '0 2px 10px rgba(0, 0, 0, 0.05)';
                noDataMsg.style.margin = '20px 0';
                noDataMsg.style.fontSize = '0.85rem';
                noDataMsg.innerHTML = '<i class="fas fa-info-circle" style="font-size: 2rem; margin-bottom: 10px; color: #95a5a6;"></i><br>אין הזמנות להצגה';
                formContainer.appendChild(noDataMsg);
            }

            document.addEventListener('click', function (e) {
                if (activeRow && !tableContainer.contains(e.target)) {
                    const activeOverlay = activeRow.querySelector('.row-action-overlay');
                    if (activeOverlay) {
                        activeOverlay.style.display = 'none';
                    }
                    activeRow = null;
                }
            });
        }

        function loadRecordToForm(item) {
            document.getElementById('department').value = item.Rsh_mchlaka || '';
            document.getElementById('supplierName').value = item.Rsh_sapak || '';
            console.log(item.Rsh_patoor); // בדוק מה הערך של Rsh_patoor
            if (document.getElementById('exempt')) {
                document.getElementById('exempt').checked = item.Rsh_patoor === '1'; // אם הערך הוא '1', סמן את ה-checkbox
            }
            document.getElementById('amount').value = item.Rsh_schoom || '';
            document.getElementById('deliveryPlace').value = item.Rsh_aspaka || '';
            document.getElementById('agentNumber').value = item.Rsh_sochen || '';
            document.getElementById('contactName').value = item.Rsh_cname || '';
            document.getElementById('contactPhone').value = item.Rsh_cnametl || '';
            document.getElementById('contactEmail').value = item.Rsh_cemail || '';
            document.getElementById('projectName').value = item.Rsh_proyktnam || '';
            document.getElementById('budgetItem').value = item.Rsh_takziv || '';

            // Set hidden fields if necessary
            document.getElementById('autoNumber').value = item.Rsh_id || ''; // Assuming Rsh_id is the identifier
            document.getElementById('timestamp').value = item.Rsh_date || ''; // Assuming Rsh_date is the timestamp
            checkFormCompletion();
        }


        function showActionButtons(item, row) {
            const existingActionContainer = document.getElementById('actionContainer');
            if (existingActionContainer) {
                existingActionContainer.remove();
            }

            const buttonContainer = row.querySelector('div');
            buttonContainer.style.display = 'flex'; // Show buttons

            const newActionContainer = document.createElement('div');
            newActionContainer.id = 'actionContainer';
            newActionContainer.style.position = 'absolute';
            newActionContainer.style.zIndex = '10';
            newActionContainer.style.backgroundColor = '#ffffff';
            newActionContainer.style.border = '1px solid #ddd';
            newActionContainer.style.borderRadius = '5px';
            newActionContainer.style.boxShadow = '0 4px 10px rgba(0, 0, 0, 0.1)';
            newActionContainer.style.padding = '10px';
            newActionContainer.style.marginTop = '-50px'; // Adjust as needed
            newActionContainer.style.left = row.getBoundingClientRect().left + 'px';
            newActionContainer.style.top = row.getBoundingClientRect().top + 'px';

            document.body.appendChild(newActionContainer);
        }





        window.addEventListener('beforeunload', function () {
            updateUser(localStorage.getItem('userId'),
                {
                    Lg_timestmpiout: new Date().toLocaleString('sv-SE'),
                    Lg_status: 0
                }
            );
        });
        document.addEventListener('DOMContentLoaded', function () {
            checkPR();
            if (document.referrer.includes("login")) {
                updateUser(localStorage.getItem('userId'), {
                    Lg_timestmpin: new Date().toLocaleString('sv-SE'),
                    Lg_status: 1
                });
            }
        });

        function checkPR() {

            if (localStorage.getItem('PR') === '2') {
                document.getElementById('conditionalButton').style.display = 'block';
            } else {
                document.getElementById('conditionalButton').style.display = 'none';
            }
        }

        function goToAdmin() {
            window.location.href = 'admin.html';
        }


        async function loadDocuments(id) {
            isFunctionCalled = true;
            const documentsArea = document.getElementById('documents-area');
            const tbody = document.getElementById('documents-body');
            const table = document.getElementById('documentsTable');
            const messageDiv = document.getElementById('message');

            // Clear previous content
            tbody.innerHTML = '';

            // Handle undefined ID case
            if (id === undefined) {
                documentsArea.classList.add('empty');
                messageDiv.innerHTML = '<i class="fas fa-info-circle"></i> יש לבחור הזמנה על מנת להציג מסמכים';
                messageDiv.style.display = 'block';
                table.style.display = 'none';
                isFunctionCalled = false;
                checkFunctionCall();
                return;
            }

            try {
                // Fetch documents
                const response = await listMnilvim(id);

                // Check if response has data property and it's an array
                const documents = Array.isArray(response) ? response :
                    (response.data && Array.isArray(response.data)) ? response.data : [];

                RSH_ID = id; // Set the global RSH_ID to the current id

                if (documents.length === 0) {
                    documentsArea.classList.add('empty');
                    messageDiv.innerHTML = '<i class="fas fa-info-circle"></i> אין מסמכים נלווים';
                    messageDiv.style.display = 'block';
                    table.style.display = 'none';
                } else {
                    documentsArea.classList.remove('empty');
                    messageDiv.style.display = 'none';
                    table.style.display = 'table';

                    documents.forEach(doc => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                    <td>${doc.MN_pratim}</td>
                    <td>${doc.MN_dateAdd}</td>
                    <td><button onclick="deleteDocument('${doc.MN_id}', event)"><i class="fas fa-trash"></i> מחק</button></td>
                `;
                        row.onclick = () => fetchDocument(doc.MN_location, doc.MN_pratim);
                        tbody.appendChild(row);
                    });
                }
            } catch (error) {
                console.error('Error loading documents:', error);
                documentsArea.classList.add('empty');
                messageDiv.innerHTML = '<i class="fas fa-exclamation-circle"></i> שגיאה בטעינת המסמכים';
                messageDiv.style.display = 'block';
                table.style.display = 'none';
            }
        }


        async function fetchDocument(url) {
            const httpUrl = url.replace(/^file:\/\//, 'http://localhost/');
            const a = document.createElement('a');
            a.href = httpUrl;
            a.download = ''; // זה יגרום לדפדפן להוריד את הקובץ
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }


        function checkFunctionCall() {
            if (!isFunctionCalled) {
                const documentsArea = document.getElementById('documents-area');
                const messageDiv = document.getElementById('message');
                const table = document.getElementById('documentsTable');

                documentsArea.classList.add('empty');
                messageDiv.innerHTML = 'יש לבחור הזמנה על מנת להציג מסמכים';
                messageDiv.style.display = 'block';
                table.style.display = 'none';
            }
        }

        async function deleteDocument(id) {
            event.stopPropagation(); // מונע מהאירוע להתפשט ולגרום להורדת המסמך

            const result = await Swal.fire({
                title: 'אישור מחיקה',
                text: 'האם אתה בטוח שברצונך למחוק מסמך זה?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'כן, מחק את זה!',
                cancelButtonText: 'לא, ביטול'
            });

            if (result.isConfirmed) {
                await deleteMnilvim(id);
                Swal.fire('נמחק!', 'המסמך נמחק.', 'success');
                loadDocuments(RSH_ID); // טען מחדש את המסמכים
            }
        }


    </script>
</body>

</html>